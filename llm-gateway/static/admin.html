<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Gateway Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0a0a0f;
            --bg2: #12121a;
            --bg3: #1a1a25;
            --text: #e0e0e0;
            --text2: #888;
            --accent: #6366f1;
            --accent2: #818cf8;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #eab308;
            --border: #2a2a3a;
        }
        body {
            font-family: 'SF Mono', 'Fira Code', monospace;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            line-height: 1.5;
        }
        .container {
            display: grid;
            grid-template-columns: 200px 1fr;
            min-height: 100vh;
        }
        /* Sidebar */
        .sidebar {
            background: var(--bg2);
            border-right: 1px solid var(--border);
            padding: 20px 0;
        }
        .logo {
            padding: 0 20px 20px;
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
        }
        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .nav-item:hover { background: var(--bg3); }
        .nav-item.active {
            background: var(--bg3);
            border-left-color: var(--accent);
            color: var(--accent2);
        }
        /* Main */
        .main {
            padding: 20px;
            overflow-y: auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 { font-size: 20px; font-weight: 500; }
        .page { display: none; }
        .page.active { display: block; }
        /* Cards */
        .card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text2);
        }
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent2);
        }
        .stat-label { color: var(--text2); font-size: 12px; }
        /* Status indicators */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-healthy { background: var(--green); }
        .status-unhealthy { background: var(--red); }
        /* Model cards */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }
        .model-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .model-name {
            font-weight: bold;
            color: var(--accent);
            font-size: 14px;
        }
        .model-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .model-badge.loaded { background: rgba(34,197,94,0.2); color: var(--green); }
        .model-badge.available { background: rgba(136,136,136,0.2); color: var(--text2); }
        .model-info { font-size: 12px; color: var(--text2); margin-bottom: 8px; }
        .model-actions { margin-top: 12px; display: flex; gap: 8px; }
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        th { color: var(--text2); font-weight: 500; font-size: 11px; text-transform: uppercase; }
        tr:hover { background: var(--bg3); }
        /* Buttons */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent2); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover { opacity: 0.8; }
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover { opacity: 0.8; }
        .btn-secondary { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        /* Forms */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; color: var(--text2); font-size: 12px; }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        textarea { resize: vertical; min-height: 80px; }
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal h2 { margin-bottom: 16px; }
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            z-index: 200;
            animation: slideIn 0.3s;
        }
        .toast.success { border-color: var(--green); color: var(--green); }
        .toast.error { border-color: var(--red); color: var(--red); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        /* Auth */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .auth-box {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 32px;
            width: 350px;
        }
        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid;
        }
        .alert-warning {
            background: rgba(234,179,8,0.1);
            border-color: var(--yellow);
            color: var(--yellow);
        }
        /* Search bar */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .search-bar input { flex: 1; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-box">
            <h2 style="margin-bottom: 20px; color: var(--accent);">üîê Admin Login</h2>
            <div class="form-group">
                <label>Admin Key</label>
                <input type="password" id="adminKeyInput" placeholder="Enter admin key">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container" style="display: none;">
        <nav class="sidebar">
            <div class="logo">‚ö° LLM Gateway</div>
            <div class="nav-item active" data-page="dashboard">üìä Dashboard</div>
            <div class="nav-item" data-page="models">üß† Models</div>
            <div class="nav-item" data-page="hf">ü§ó HF Browser</div>
            <div class="nav-item" data-page="users">üë• Users</div>
            <div class="nav-item" data-page="signups">üìù Signups</div>
            <div class="nav-item" data-page="config">‚öôÔ∏è Config</div>
        </nav>

        <main class="main">
            <!-- Dashboard -->
            <div id="page-dashboard" class="page active">
                <div class="header">
                    <h1>Dashboard</h1>
                    <span id="lastUpdate" style="color: var(--text2);"></span>
                </div>

                <!-- Pending Signups Alert -->
                <div id="pendingSignupsAlert" class="alert alert-warning" style="display: none;">
                    <strong>üìù Pending Signup Requests</strong>
                    <span id="pendingCount"></span>
                    <button class="btn btn-primary btn-sm" style="margin-left: 12px;" onclick="switchPage('signups')">Review Now</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Ollama Status</div>
                        <div class="stat-value" id="ollamaStatus" style="font-size: 16px;">
                            <span class="status-dot"></span>
                            <span>Checking...</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text2); margin-top: 4px;">
                            Mode: <span id="backendMode">-</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Models</div>
                        <div class="stat-value" id="activeModels">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">24h Requests</div>
                        <div class="stat-value" id="requests24h">0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Active Models</div>
                    <div id="activeModelsGrid" class="models-grid"></div>
                </div>
            </div>

            <!-- Models -->
            <div id="page-models" class="page">
                <div class="header">
                    <h1>Models</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-success" onclick="openLoadModal()">+ Load Model</button>
                        <button class="btn btn-primary" onclick="openPullModal()">‚¨á Pull Model</button>
                        <button class="btn btn-secondary" onclick="openImportModal()">üì¶ Import GGUF</button>
                        <button class="btn btn-secondary" onclick="loadModels()">‚Üª Refresh</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Gateway Active Models</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Model Name</th>
                                <th>Type</th>
                                <th>Keep Alive</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gatewayModelsTable">
                            <tr><td colspan="5" style="color: var(--text2); text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">Ollama Models (Available)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ollamaModelsTable">
                            <tr><td colspan="4" style="color: var(--text2); text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- HF Browser -->
            <div id="page-hf" class="page">
                <div class="header">
                    <h1>HuggingFace Browser</h1>
                </div>

                <div class="card">
                    <div class="search-bar">
                        <input type="text" id="hfSearchInput" placeholder="Search GGUF models (e.g., llama3, qwen2.5-coder)">
                        <button class="btn btn-primary" onclick="searchHF()">Search</button>
                    </div>
                    <div id="hfResults"></div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div class="card-title" style="margin: 0;">Local GGUF Files</div>
                        <button class="btn btn-sm btn-secondary" onclick="loadLocalFiles()">‚Üª Refresh</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Size</th>
                                <th>Path</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="localFilesTable">
                            <tr><td colspan="4" style="color: var(--text2); text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users -->
            <div id="page-users" class="page">
                <div class="header">
                    <h1>Users</h1>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Add User</button>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Balance</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="5" style="color: var(--text2); text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Signups -->
            <div id="page-signups" class="page">
                <div class="header">
                    <h1>Signup Requests</h1>
                    <button class="btn btn-secondary" onclick="loadSignups()">‚Üª Refresh</button>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="signupsTable">
                            <tr><td colspan="5" style="color: var(--text2); text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Config -->
            <div id="page-config" class="page">
                <div class="header">
                    <h1>Configuration</h1>
                </div>

                <div class="card">
                    <div class="card-title">Gateway Settings</div>
                    <div class="form-group">
                        <label>Ollama URL</label>
                        <input type="text" id="configOllamaUrl" placeholder="http://localhost:11434">
                    </div>
                    <div class="form-group">
                        <label>Backend Mode</label>
                        <select id="configBackendMode">
                            <option value="bare">Bare Metal</option>
                            <option value="docker">Docker</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>HuggingFace Token (optional)</label>
                        <input type="password" id="configHfToken" placeholder="hf_...">
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Rate Limiting (Requests/Minute)</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>PAYG Tier (RPM)</label>
                            <input type="number" id="configDefaultRpm" placeholder="5">
                        </div>
                        <div class="form-group">
                            <label>Subscription Tier (RPM)</label>
                            <input type="number" id="configDefaultRpd" placeholder="10">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Pricing (per 1K tokens)</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Input Token Price ($)</label>
                            <input type="number" step="0.0001" id="configInputPrice" placeholder="0.0001">
                        </div>
                        <div class="form-group">
                            <label>Output Token Price ($)</label>
                            <input type="number" step="0.0001" id="configOutputPrice" placeholder="0.0002">
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveConfig()">Save Configuration</button>
            </div>
        </main>
    </div>

    <!-- Load Model Modal -->
    <div id="loadModal" class="modal-overlay">
        <div class="modal">
            <h2>Load Model</h2>
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="loadModelName" placeholder="e.g., llama3.2, qwen2.5-coder:7b">
            </div>
            <div class="form-group">
                <label>Model Type</label>
                <select id="loadModelType">
                    <option value="auto">Auto-detect</option>
                    <option value="text">Text</option>
                    <option value="vision">Vision</option>
                    <option value="omni">Omni</option>
                    <option value="embedding">Embedding</option>
                    <option value="tts">TTS</option>
                    <option value="audio">Audio</option>
                </select>
            </div>
            <div class="form-group">
                <label>Keep Alive</label>
                <select id="loadKeepAlive">
                    <option value="-1">Forever (-1)</option>
                    <option value="5m">5 minutes</option>
                    <option value="30m" selected>30 minutes</option>
                    <option value="1h">1 hour</option>
                </select>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeModal('loadModal')">Cancel</button>
                <button class="btn btn-success" onclick="loadModel()">Load Model</button>
            </div>
        </div>
    </div>

    <!-- Pull Model Modal -->
    <div id="pullModal" class="modal-overlay">
        <div class="modal">
            <h2>Pull Model from Ollama Registry</h2>
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="pullModelName" placeholder="e.g., llama3.2, mistral:7b">
                <small style="color: var(--text2); display: block; margin-top: 4px;">
                    Browse at <a href="https://ollama.com/library" target="_blank" style="color: var(--accent);">ollama.com/library</a>
                </small>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeModal('pullModal')">Cancel</button>
                <button class="btn btn-primary" onclick="pullModel()">Pull Model</button>
            </div>
        </div>
    </div>

    <!-- Import GGUF Modal -->
    <div id="importModal" class="modal-overlay">
        <div class="modal">
            <h2>Import GGUF into Ollama</h2>
            <div class="form-group">
                <label>GGUF File Path</label>
                <input type="text" id="importGGUFPath" placeholder="/path/to/model.gguf">
                <small style="color: var(--text2); display: block; margin-top: 4px;">
                    Absolute path or relative to data/models/
                </small>
            </div>
            <div class="form-group">
                <label>Model Name (in Ollama)</label>
                <input type="text" id="importModelName" placeholder="my-model:latest">
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                <button class="btn btn-primary" onclick="importGGUF()">Import</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal-overlay">
        <div class="modal">
            <h2>Add User</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userUsername" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Tier</label>
                <select id="userRpm">
                    <option value="payg">PAYG (Pay-as-you-go)</option>
                    <option value="sub">Subscription</option>
                </select>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                <button class="btn btn-success" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>

    <script>
        let API_KEY = localStorage.getItem('adminKey') || '';
        let refreshInterval = null;

        // Auth
        function login() {
            API_KEY = document.getElementById('adminKeyInput').value;
            localStorage.setItem('adminKey', API_KEY);
            checkAuth();
        }

        async function checkAuth() {
            if (!API_KEY) {
                showAuthScreen();
                return;
            }

            try {
                const resp = await fetch('/admin/api/system', {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });

                if (resp.ok) {
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'grid';
                    init();
                } else {
                    localStorage.removeItem('adminKey');
                    API_KEY = '';
                    showAuthScreen();
                }
            } catch (e) {
                showAuthScreen();
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // API Helper
        async function api(path, options = {}) {
            const resp = await fetch(path, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (resp.status === 401 || resp.status === 403) {
                localStorage.removeItem('adminKey');
                API_KEY = '';
                showAuthScreen();
                throw new Error('Unauthorized');
            }
            return resp;
        }

        // Toast
        function toast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Navigation
        function switchPage(page) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            document.getElementById(`page-${page}`).classList.add('active');
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = () => switchPage(item.dataset.page);
        });

        // Modal
        function openLoadModal() {
            document.getElementById('loadModal').classList.add('active');
        }
        function openPullModal() {
            document.getElementById('pullModal').classList.add('active');
        }
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }
        function openUserModal() {
            document.getElementById('userModal').classList.add('active');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Check pending signups
                try {
                    const signupsResp = await api('/admin/api/signups');
                    const signups = await signupsResp.json();
                    const pending = Array.isArray(signups) ? signups.filter(s => s.status === 'pending') : [];

                    if (pending.length > 0) {
                        document.getElementById('pendingSignupsAlert').style.display = 'block';
                        document.getElementById('pendingCount').textContent = ` (${pending.length} waiting)`;
                    } else {
                        document.getElementById('pendingSignupsAlert').style.display = 'none';
                    }
                } catch (e) {
                    document.getElementById('pendingSignupsAlert').style.display = 'none';
                }

                // System stats
                const sysResp = await api('/admin/api/system');
                const sys = await sysResp.json();

                // Ollama status
                const statusDot = document.querySelector('#ollamaStatus .status-dot');
                const statusText = document.querySelector('#ollamaStatus span:last-child');
                if (sys.ollama && sys.ollama.healthy) {
                    statusDot.className = 'status-dot status-healthy';
                    statusText.textContent = 'Healthy';
                } else {
                    statusDot.className = 'status-dot status-unhealthy';
                    statusText.textContent = 'Unhealthy';
                }
                document.getElementById('backendMode').textContent = sys.backend_mode || 'bare';

                // Models (server returns array directly)
                const modelsResp = await api('/admin/api/models');
                const models = await modelsResp.json();
                const modelsList = Array.isArray(models) ? models : [];
                document.getElementById('activeModels').textContent = modelsList.length;

                // Users (server returns array directly)
                const usersResp = await api('/admin/api/users');
                const users = await usersResp.json();
                const usersList = Array.isArray(users) ? users : [];
                document.getElementById('totalUsers').textContent = usersList.length;

                // 24h stats - not in system endpoint, show 0
                document.getElementById('requests24h').textContent = '-';

                // Active models grid
                const grid = document.getElementById('activeModelsGrid');
                if (modelsList.length > 0) {
                    grid.innerHTML = modelsList.map(m => `
                        <div class="model-card">
                            <div class="model-header">
                                <span class="model-name">${m.model_name}</span>
                                <span class="model-badge loaded">${m.status || 'Loaded'}</span>
                            </div>
                            <div class="model-info">Type: ${m.model_type}</div>
                            <div class="model-info">Keep Alive: ${m.keep_alive || 'Default'}</div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div style="color: var(--text2);">No models loaded</div>';
                }

                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error('Dashboard load failed:', e);
            }
        }

        // Models
        async function loadModels() {
            try {
                const [gatewayResp, ollamaResp] = await Promise.all([
                    api('/admin/api/models'),
                    api('/admin/api/models/ollama')
                ]);

                const gatewayModels = await gatewayResp.json();
                const ollamaModels = await ollamaResp.json();
                const gwList = Array.isArray(gatewayModels) ? gatewayModels : [];
                const olList = Array.isArray(ollamaModels) ? ollamaModels : [];

                // Gateway models
                const gatewayTable = document.getElementById('gatewayModelsTable');
                if (gwList.length > 0) {
                    gatewayTable.innerHTML = gwList.map(m => `
                        <tr>
                            <td>${m.model_name}</td>
                            <td>${m.model_type}</td>
                            <td>${m.keep_alive || 'Default'}</td>
                            <td>${m.status || 'running'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="unloadModel('${m.model_name}')">Unload</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    gatewayTable.innerHTML = '<tr><td colspan="5" style="color: var(--text2); text-align: center;">No models loaded</td></tr>';
                }

                // Ollama models
                const ollamaTable = document.getElementById('ollamaModelsTable');
                if (olList.length > 0) {
                    ollamaTable.innerHTML = olList.map(m => `
                        <tr>
                            <td>${m.name}</td>
                            <td>${m.size_gb ? m.size_gb + ' GB' : 'N/A'}</td>
                            <td>${m.modified_at ? new Date(m.modified_at).toLocaleString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="quickLoadModel('${m.name}')">Load</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteModel('${m.name}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    ollamaTable.innerHTML = '<tr><td colspan="4" style="color: var(--text2); text-align: center;">No models in Ollama. Pull a model to get started.</td></tr>';
                }
            } catch (e) {
                toast('Failed to load models: ' + e.message, 'error');
            }
        }

        async function loadModel() {
            const name = document.getElementById('loadModelName').value;
            const type = document.getElementById('loadModelType').value;
            const keepAlive = document.getElementById('loadKeepAlive').value;

            if (!name) {
                toast('Please enter a model name', 'error');
                return;
            }

            try {
                const resp = await api('/admin/api/models/load', {
                    method: 'POST',
                    body: JSON.stringify({
                        model_name: name,
                        model_type: type,
                        keep_alive: keepAlive
                    })
                });

                if (resp.ok) {
                    toast(`Model ${name} loaded`);
                    closeModal('loadModal');
                    loadModels();
                    loadDashboard();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Failed to load', 'error');
                }
            } catch (e) {
                toast('Failed to load: ' + e.message, 'error');
            }
        }

        async function quickLoadModel(name) {
            try {
                const resp = await api('/admin/api/models/load', {
                    method: 'POST',
                    body: JSON.stringify({
                        model_name: name,
                        model_type: 'auto',
                        keep_alive: '30m'
                    })
                });

                if (resp.ok) {
                    toast(`Model ${name} loaded`);
                    loadModels();
                    loadDashboard();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Failed to load', 'error');
                }
            } catch (e) {
                toast('Failed to load: ' + e.message, 'error');
            }
        }

        async function unloadModel(name) {
            if (!confirm(`Unload model ${name}?`)) return;

            try {
                const resp = await api(`/admin/api/models/${encodeURIComponent(name)}/unload`, {
                    method: 'POST'
                });

                if (resp.ok) {
                    toast(`Model ${name} unloaded`);
                    loadModels();
                    loadDashboard();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Failed to unload', 'error');
                }
            } catch (e) {
                toast('Failed to unload: ' + e.message, 'error');
            }
        }

        async function deleteModel(name) {
            if (!confirm(`Delete model ${name} from Ollama? This cannot be undone.`)) return;

            try {
                const resp = await api('/admin/api/models/delete', {
                    method: 'POST',
                    body: JSON.stringify({ model_name: name })
                });

                if (resp.ok) {
                    toast(`Model ${name} deleted`);
                    loadModels();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Failed to delete', 'error');
                }
            } catch (e) {
                toast('Failed to delete: ' + e.message, 'error');
            }
        }

        async function pullModel() {
            const name = document.getElementById('pullModelName').value;
            if (!name) {
                toast('Please enter a model name', 'error');
                return;
            }

            try {
                toast(`Pulling model ${name}... This may take a while.`);
                closeModal('pullModal');

                const resp = await api('/admin/api/models/pull', {
                    method: 'POST',
                    body: JSON.stringify({ model_name: name })
                });

                if (resp.ok) {
                    toast(`Model ${name} pulled successfully`);
                    loadModels();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Failed to pull', 'error');
                }
            } catch (e) {
                toast('Failed to pull: ' + e.message, 'error');
            }
        }

        async function importGGUF() {
            const path = document.getElementById('importGGUFPath').value;
            const name = document.getElementById('importModelName').value;

            if (!path || !name) {
                toast('Please enter both path and model name', 'error');
                return;
            }

            try {
                toast(`Importing GGUF... This may take a while.`);
                closeModal('importModal');

                const resp = await api('/admin/api/models/import-gguf', {
                    method: 'POST',
                    body: JSON.stringify({
                        gguf_path: path,
                        model_name: name
                    })
                });

                if (resp.ok) {
                    toast(`GGUF imported as ${name}`);
                    loadModels();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Failed to import', 'error');
                }
            } catch (e) {
                toast('Failed to import: ' + e.message, 'error');
            }
        }

        // HF Browser
        async function searchHF() {
            const q = document.getElementById('hfSearchInput').value;
            if (!q) {
                toast('Please enter a search query', 'error');
                return;
            }

            const results = document.getElementById('hfResults');
            results.innerHTML = '<div style="color: var(--text2);">Searching...</div>';

            try {
                const resp = await api(`/admin/api/models/search-hf?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                const repoList = Array.isArray(data) ? data : [];

                if (repoList.length > 0) {
                    results.innerHTML = repoList.map(r => `
                        <div class="card">
                            <div style="font-weight: 500; margin-bottom: 8px;">${r.repo_id}</div>
                            <div style="font-size: 12px; color: var(--text2); margin-bottom: 4px;">
                                Downloads: ${r.downloads || 0} | Likes: ${r.likes || 0}
                            </div>
                            <div style="font-size: 12px; margin-bottom: 8px;">
                                ${(r.files || []).map(f => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--border);">
                                        <span style="color: var(--text2);">${f}</span>
                                        <button class="btn btn-sm btn-primary" onclick="downloadHF('${r.repo_id}', '${f}')">Download</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                } else if (data.error) {
                    results.innerHTML = `<div style="color: var(--red);">${data.error}</div>`;
                } else {
                    results.innerHTML = '<div style="color: var(--text2);">No GGUF models found</div>';
                }
            } catch (e) {
                results.innerHTML = `<div style="color: var(--red);">Search failed: ${e.message}</div>`;
            }
        }

        async function downloadHF(repo, file) {
            try {
                toast(`Downloading ${file}... This may take a while.`);

                const resp = await api('/admin/api/models/download-hf', {
                    method: 'POST',
                    body: JSON.stringify({
                        repo_id: repo,
                        filename: file
                    })
                });

                if (resp.ok) {
                    toast(`Downloaded ${file}`);
                    loadLocalFiles();
                } else {
                    const err = await resp.json();
                    toast(err.error || 'Download failed', 'error');
                }
            } catch (e) {
                toast('Download failed: ' + e.message, 'error');
            }
        }

        async function loadLocalFiles() {
            try {
                const resp = await api('/admin/api/models/local');
                const files = await resp.json();
                const filesList = Array.isArray(files) ? files : [];

                const table = document.getElementById('localFilesTable');
                if (filesList.length > 0) {
                    table.innerHTML = filesList.map(f => `
                        <tr>
                            <td>${f.name}</td>
                            <td>${f.size_gb ? f.size_gb + ' GB' : f.size_mb + ' MB'}</td>
                            <td style="font-size: 11px; color: var(--text2);">${f.path}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="quickImport('${f.path}', '${f.name}')">Import to Ollama</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    table.innerHTML = '<tr><td colspan="4" style="color: var(--text2); text-align: center;">No local GGUF files found</td></tr>';
                }
            } catch (e) {
                toast('Failed to load local files: ' + e.message, 'error');
            }
        }

        function quickImport(path, filename) {
            const suggestedName = filename.replace('.gguf', '').replace(/[^a-z0-9.-]/gi, '-').toLowerCase() + ':latest';
            document.getElementById('importGGUFPath').value = path;
            document.getElementById('importModelName').value = suggestedName;
            openImportModal();
        }

        // Users
        async function loadUsers() {
            try {
                const resp = await api('/admin/api/users');
                const users = await resp.json();
                const usersList = Array.isArray(users) ? users : [];

                const table = document.getElementById('usersTable');
                if (usersList.length > 0) {
                    table.innerHTML = usersList.map(u => `
                        <tr>
                            <td>${u.email}</td>
                            <td style="font-size: 11px;">${u.tier || 'payg'}</td>
                            <td>$${(u.balance || 0).toFixed(4)}</td>
                            <td>${u.created_at ? new Date(u.created_at).toLocaleString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="createApiKey(${u.id})">+ Key</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    table.innerHTML = '<tr><td colspan="5" style="color: var(--text2); text-align: center;">No users registered</td></tr>';
                }
            } catch (e) {
                toast('Failed to load users: ' + e.message, 'error');
            }
        }

        async function createUser() {
            const email = document.getElementById('userUsername').value;
            const tier = document.getElementById('userRpm').value || 'payg';

            if (!email) {
                toast('Please enter an email', 'error');
                return;
            }

            try {
                const resp = await api('/admin/api/users', {
                    method: 'POST',
                    body: JSON.stringify({ email, tier })
                });

                if (resp.ok) {
                    const result = await resp.json();
                    toast(`User ${email} created (ID: ${result.id})`);
                    closeModal('userModal');
                    loadUsers();
                } else {
                    const err = await resp.json();
                    toast(err.detail || 'Failed to create', 'error');
                }
            } catch (e) {
                toast('Failed to create: ' + e.message, 'error');
            }
        }

        async function createApiKey(userId) {
            try {
                const resp = await api(`/admin/api/users/${userId}/apikey`, {
                    method: 'POST',
                    body: JSON.stringify({ user_id: userId, name: 'default' })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    prompt('New API key (copy it now, it will not be shown again):', data.key);
                    loadUsers();
                } else {
                    const err = await resp.json();
                    toast(err.detail || 'Failed to create key', 'error');
                }
            } catch (e) {
                toast('Failed to create key: ' + e.message, 'error');
            }
        }

        // Signups
        async function loadSignups() {
            try {
                const resp = await api('/admin/api/signups');
                const signups = await resp.json();
                const signupsList = Array.isArray(signups) ? signups : [];

                const table = document.getElementById('signupsTable');
                if (signupsList.length > 0) {
                    table.innerHTML = signupsList.map(s => `
                        <tr>
                            <td>${s.email}</td>
                            <td>${s.tier || 'payg'}</td>
                            <td>${s.status}</td>
                            <td>${s.created_at ? new Date(s.created_at).toLocaleString() : 'N/A'}</td>
                            <td>
                                ${s.status === 'pending' ? `
                                    <button class="btn btn-sm btn-success" onclick="approveSignup(${s.id})">Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectSignup(${s.id})">Reject</button>
                                ` : `<span style="color: var(--text2);">${s.status}</span>`}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    table.innerHTML = '<tr><td colspan="5" style="color: var(--text2); text-align: center;">No signup requests</td></tr>';
                }
            } catch (e) {
                toast('Failed to load signups: ' + e.message, 'error');
            }
        }

        async function approveSignup(requestId) {
            try {
                const resp = await api(`/admin/api/signups/${requestId}/approve`, {
                    method: 'POST'
                });

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.api_key) {
                        prompt('User approved! API key (copy now):', data.api_key);
                    } else {
                        toast('Signup approved');
                    }
                    loadSignups();
                    loadDashboard();
                    loadUsers();
                } else {
                    const err = await resp.json();
                    toast(err.detail || 'Failed to approve', 'error');
                }
            } catch (e) {
                toast('Failed to approve: ' + e.message, 'error');
            }
        }

        async function rejectSignup(requestId) {
            if (!confirm('Reject this signup request?')) return;

            try {
                const resp = await api(`/admin/api/signups/${requestId}/reject`, {
                    method: 'POST'
                });

                if (resp.ok) {
                    toast('Signup rejected');
                    loadSignups();
                    loadDashboard();
                } else {
                    const err = await resp.json();
                    toast(err.detail || 'Failed to reject', 'error');
                }
            } catch (e) {
                toast('Failed to reject: ' + e.message, 'error');
            }
        }

        // Config
        async function loadConfig() {
            try {
                const resp = await api('/admin/api/config');
                const data = await resp.json();

                document.getElementById('configOllamaUrl').value = data.ollama_url || '';
                document.getElementById('configBackendMode').value = data.backend_mode || 'bare';
                document.getElementById('configHfToken').value = data.hf_token || '';
                const rl = data.rate_limits || {};
                document.getElementById('configDefaultRpm').value = rl.payg || '';
                document.getElementById('configDefaultRpd').value = rl.sub || '';
                const pricing = data.pricing || {};
                document.getElementById('configInputPrice').value = pricing.input_per_1k || '';
                document.getElementById('configOutputPrice').value = pricing.output_per_1k || '';
            } catch (e) {
                toast('Failed to load config: ' + e.message, 'error');
            }
        }

        async function saveConfig() {
            const config = {
                ollama_url: document.getElementById('configOllamaUrl').value,
                backend_mode: document.getElementById('configBackendMode').value,
            };

            const hfToken = document.getElementById('configHfToken').value;
            if (hfToken && !hfToken.endsWith('...')) config.hf_token = hfToken;

            const payg = parseInt(document.getElementById('configDefaultRpm').value);
            const sub = parseInt(document.getElementById('configDefaultRpd').value);
            if (payg || sub) {
                config.rate_limits = {};
                if (payg) config.rate_limits.payg = payg;
                if (sub) config.rate_limits.sub = sub;
            }

            const inputPrice = parseFloat(document.getElementById('configInputPrice').value);
            const outputPrice = parseFloat(document.getElementById('configOutputPrice').value);
            if (inputPrice || outputPrice) {
                config.pricing = {};
                if (inputPrice) config.pricing.input_per_1k = inputPrice;
                if (outputPrice) config.pricing.output_per_1k = outputPrice;
            }

            try {
                const resp = await api('/admin/api/config', {
                    method: 'PATCH',
                    body: JSON.stringify(config)
                });

                if (resp.ok) {
                    toast('Configuration saved');
                } else {
                    const err = await resp.json();
                    toast(err.detail || 'Failed to save', 'error');
                }
            } catch (e) {
                toast('Failed to save: ' + e.message, 'error');
            }
        }

        // Utilities
        function formatSize(bytes) {
            if (!bytes) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIdx = 0;
            while (size >= 1024 && unitIdx < units.length - 1) {
                size /= 1024;
                unitIdx++;
            }
            return `${size.toFixed(1)} ${units[unitIdx]}`;
        }

        // Init
        async function init() {
            await loadDashboard();
            await loadModels();
            await loadUsers();
            await loadSignups();
            await loadConfig();
            await loadLocalFiles();

            // Auto refresh dashboard every 30 seconds
            refreshInterval = setInterval(loadDashboard, 30000);
        }

        // Start
        checkAuth();
    </script>
</body>
</html>
