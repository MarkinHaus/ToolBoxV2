<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/app/scripts/scripts.js" type="module" defer></script>
    <script src="/app/scripts/httpSender.js" type="module" defer></script>
    <script src="/app/scripts/WorkerSocketRenderer.js" defer></script>
    <link rel="stylesheet" href="/app/assets/styles.css">
</head>
<body>
<div id="overlay"></div>
<header>
    <nav>
        <ul>
            <li><a href="/app">Start</a></li>
            <li><a href="/app/signup">Sign Up</a></li>
            <li><a href="/app/login">Login</a></li>
            <li><a href="/app/asset/terms.html">Terms and Conditions</a></li>
            <li><a href="/app/dashboards/dashboard.html">Dashboard</a></li>
        </ul>
    </nav>
    <div class="dark-mode-toggle">
        <input type="checkbox" id="darkModeToggle">
        <label for="darkModeToggle" id="toggleLabel">☀️</label>
    </div>
</header>

<main >
    <div id="threeDScene"></div>
    <div class="main-content frosted-glass">
<section id="signup">
    <div class="form-container">
        <form id="signupForm" class="form">
            <h2 id="titel-h2">Sign Up</h2>

            <div id="infoPopup" class="form-container" style="display: none; z-index: 1000;">
            <p id="infoText"></p>
            </div>
            <input id="username" type="text" placeholder="Username">
            <input id="email" type="email" placeholder="Email">
            <input id="initiation" type="password" placeholder="Initiation-Key">
            <button type="submit" id="submit-button">Sign Up</button>
            <button type="submit" class="none" id="skip-persona-button">Only Device</button>
        </form>
    </div>
</section>
    </div>
</main>


<script type="module">

    import {httpPostData} from "/app/scripts/httpSender.js";
    import {registerUser, generateAsymmetricKeys, storePrivateKey, decryptAsymmetric, signMessage} from "/app/scripts/cryp.js";

    let UserData = undefined
    let registrationData = undefined
    let privateKey_base64 = null
    let username

    document.addEventListener('DOMContentLoaded', () => {

        function handleCreateUserError(data) {
            console.log("[handleCreateUserError data]:", data)
            document.getElementById('infoText').textContent = data.info.help_text;
            document.getElementById('infoPopup').style.display = 'block';
            UserData = undefined
            document.getElementById('titel-h2').textContent = "Sing Up"
            document.getElementById('username').classList.remove('none')
            document.getElementById('email').classList.remove('none')
            document.getElementById('initiation').classList.remove('none')
            return data
        }

        async function handleCreateUserSuccess(data) {
            console.log("[handleCreateUserSuccess data]:", data)
            registrationData = data.get()
            UserData = true
            document.getElementById('submit-button').textContent = "Retry";
            document.getElementById('infoText').textContent = "Now we linke your account with your Persona. A pop-up window should appear. If it does not appear, please click on 'Retry' manually.";
            document.getElementById('infoPopup').style.display = 'block';
            document.getElementById('titel-h2').textContent = "Sing Up for "+document.getElementById('username').value
            document.getElementById('username').classList.add('none')
            document.getElementById('email').classList.add('none')
            document.getElementById('initiation').classList.add('none')

            console.log("[registrationData--]:", registrationData)
            console.log("[registrationData.dSync, keys.privateKey_base64]:", registrationData.dSync, privateKey_base64)
            const deviceID = await decryptAsymmetric(registrationData.dSync, privateKey_base64, true)
            await window.sessionStorage.setItem("SKey", deviceID)
            await storePrivateKey(privateKey_base64, username)
            await registrate_user_personal(await signMessage(privateKey_base64, registrationData.challenge))

            return data
        }
        function handleCreateUserErrorPersona(data) {
            console.log("[handleCreateUserError data]:", data)
            document.getElementById('infoText').textContent = data.info.help_text;
            document.getElementById('infoPopup').style.display = 'block';
            UserData = undefined
            return data
        }

        async function handleCreateUserSuccessPersona(data) {
            console.log("[handleCreateUserSuccess data]:", data)
            setTimeout(()=>{ window.location.href = "/app/dashboard";}, 120)
            return data
        }

        async function createUser(name, email, invitation, pub_key) {
            return httpPostData('CloudM.AuthManager',
                'create_user',
                {
                    name, email ,pub_key ,invitation,
                    web_data:true, as_base64:false
                },
                handleCreateUserError, handleCreateUserSuccess);
        }

        async function registrate_user_personal(sing){
            const done = await registerUser(registrationData, sing, handleCreateUserErrorPersona, handleCreateUserSuccessPersona)
            UserData = !done
            if (done){
                sessionStorage.setItem("local_ws.onopen:installMod-welcome", 'true')
                UserData = false
                document.getElementById('titel-h2').textContent = "Welcome to SimpleCore "+document.getElementById('username').value
                document.getElementById('submit-button').textContent = "Go to dashboard";
                document.getElementById('infoText').textContent = "Verification Done";
                document.getElementById('infoPopup').style.display = 'block';
            }else{
                document.getElementById('infoText').textContent = "Pleas press on 'Retry'";
                document.getElementById('infoPopup').style.display = 'block';
            }
        }

        document.getElementById('signupForm').addEventListener('submit',async function(event) {
            event.preventDefault();

            if (document.getElementById('submit-button').textContent === "Retry"){
                document.getElementById('skip-persona-button').classList.remove('none')
                document.getElementById('infoText').textContent = "If the web auth interface is not working you can add the personal data letter. To continue press on 'Only Device'";
            }

            if (UserData === false) {
                window.location.href = "/app/dashboard";
                return
            }

            if (UserData === undefined){
                username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const invitation = document.getElementById('initiation').value;
                document.getElementById('infoText').textContent = "Validate information's";
                document.getElementById('infoPopup').style.display = 'block';
                await generateAsymmetricKeys().then(async keys => {
                    await createUser(username, email, invitation, keys.publicKey)
                    privateKey_base64 =  keys.privateKey_base64
                }, 600);
                return
            }
            console.log("[registrationData]:", registrationData)
            try {
                if (UserData === true && registrationData !== {}){
                    console.log("[registrationData--]:", registrationData)
                    if (privateKey_base64 !== undefined && privateKey_base64 !== null){
                        console.log("[registrationData.dSync, keys.privateKey_base64]:", registrationData.dSync, privateKey_base64)
                        const deviceID = await decryptAsymmetric(registrationData.dSync, privateKey_base64, true)
                        await window.sessionStorage.setItem("SKey", deviceID)
                        await storePrivateKey(privateKey_base64, username)
                        await window.sessionStorage.removeItem('temp_base64_key')
                    }
                    await registrate_user_personal(await signMessage(privateKey_base64, registrationData.challenge))
                    return
                }
            }
            catch (e) {
                console.log(e)
            }



            //generateAsymmetricKeys().then(keys => {
            //    console.log("Public Key:", keys.publicKey);
            //    // const result = createUser(username,email,invitation, keys.publicKey)
            //    // console.log("result:",result);
            //    //console.log("Private Key:", keys.privateKey);
            //    //// Verschlüsseln eines Textes
            //    //const text = "Hello, World!";
            //    //encryptAsymmetric(text, keys.publicKey).then(encrypted => {
            //    //    console.log("Encrypted:", encrypted);
            //    //    // Entschlüsseln des Textes
            //    //    decryptAsymmetric(encrypted, keys.privateKey).then(decrypted => {
            //    //        console.log("Decrypted:", decrypted);
            //    //    });
            //    //});
            //});


        });
    });
</script>
</body>
</html>
