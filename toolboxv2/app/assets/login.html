<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/app/scripts/scripts.js" type="module" defer></script>
    <script src="/app/scripts/WorkerSocketRenderer.js" defer></script>
    <script src="/app/scripts/httpSender.js" type="module" defer></script>
    <link rel="stylesheet" href="/app/assets/styles.css">
</head>
<body>
<div id="overlay"></div>
<header>
    <nav>
        <ul>
            <li><a href="/app">Start</a></li>
            <li><a href="/app/signup">Sign Up</a></li>
            <li><a href="/app/login">Login</a></li>
            <li><a href="/app/assets/terms.html">Terms and Conditions</a></li>
            <li><a href="/app/dashboards/dashboard.html">Dashboard</a></li>
        </ul>
    </nav>
    <div class="dark-mode-toggle">
        <input type="checkbox" id="darkModeToggle">
        <label for="darkModeToggle" id="toggleLabel">☀️</label>
    </div>
</header>

<!-- Your main content goes here -->
<main>
  <div id="threeDScene"></div>
  <div class="main-content frosted-glass">
    <section id="login">
      <div class="form-container">
        <form id="loginForm" class="form">
          <h2>Login</h2>

            <div id="infoPopup" class="form-container" style="display: none; z-index: 1000;">
            <p id="infoText"></p>
            <p id="remeberText"></p>
            </div>

          <input type="text" id="username" placeholder="Username">
          <label>Remember me <input type="checkbox" id="remember-me" onchange='function checkedF() {
          checked[0] = !checked[0]
          console.log("[checked]:", checked)
          document.getElementById("remember-me").classList.add("none")
          document.getElementById("remeberText").textContent = "Halten sie Ihr gerät welches sie beim sig up verwendend haben beriet."
          }
          checkedF()'></label>
          <button type="submit">Login</button>
        </form>
          <button id="get-magicking" class="none">Login Device</button>
      </div>
    </section>
  </div>
</main>

<script type="module">


    import {httpPostData, httpPostUrl} from "/app/scripts/httpSender.js";
    import {authorisazeUser, signMessage, retrievePrivateKey, decryptAsymmetric, storePrivateKey} from "/app/scripts/cryp.js";

    let base64_privat_key = null
    let checked = [false]
    let caunter = 0
    document.addEventListener('DOMContentLoaded', () => {

        function get_handleLoginError(id) {
    function handleLoginError(data) {
        console.log("[handleCreateUserError data]:",id, data)
        document.getElementById('infoText').textContent = data.info.help_text;
        document.getElementById('infoPopup').style.display = 'block';
        return data
    }
    return handleLoginError
    }

    function rr(){
        setTimeout(() => {
            localStorage.setItem("local_ws.onopen:installMod-welcome", 'false');
            window.location.href = "/app/dashboard";
        }, 200);
    }

    async function handleLoginSuccessVP(data) {
        console.log("[handleLoginSuccessVP data]:", data)
        document.getElementById('infoText').textContent = data.info.help_text;
        document.getElementById('infoPopup').style.display = 'block';
        if (base64_privat_key === null){
            throw "Device is not registered use remember me"
        }
        try {
            const deviceID = await decryptAsymmetric(data.get().key, base64_privat_key, true)
            const row_claim = await decryptAsymmetric(data.get().claim, base64_privat_key, true)
            await storePrivateKey(privateKey_base64, deviceID)
            localStorage.setItem('jwt_claim', data.get().claim);
            sessionStorage.setItem('row_jwt_claim', row_claim);
            rr()
        }catch (e){
            console.log("Error handleLoginSuccessVP", e)
        }

        return data
    }

    async function handleLoginSuccessVD(data) {
        console.log("[handleLoginSuccessVD data]:", data)
        document.getElementById('infoText').textContent = data.info.help_text;
        document.getElementById('infoPopup').style.display = 'block';
        if (base64_privat_key === null){
            throw "Device is not registered use remember me"
        }
        try {
            const claim = await decryptAsymmetric(data.get(), base64_privat_key, true)
            localStorage.setItem('jwt_claim_device', claim);
            rr()
        }catch (e){
            console.log("Error handleLoginSuccessVP", e)
        }

        return data
    }

    async function handleLoginSuccess(data) {
        document.getElementById('infoText').textContent = "Login in progress";
        document.getElementById('infoPopup').style.display = 'block';

        console.log("[checked]:", checked)

        if (checked[0]){
            if(await authorisazeUser(data.get().rowId, data.get().challenge, document.getElementById('username').value, get_handleLoginError("authorisazeUser"), handleLoginSuccessVP)){
                document.getElementById('infoText').textContent = "Validate user successful";
            }
        }else{
            const deviceID = localStorage.getItem('deviceID');

            base64_privat_key = await retrievePrivateKey(deviceID)

            if (base64_privat_key === "Invalid user name device not registered"){
                document.getElementById('infoText').textContent = "Invalid user name device not registered on '"+document.getElementById('username').value+"'";
                document.getElementById('infoPopup').style.display = 'block';
                caunter++;
            }else{
                const signature = await signMessage(base64_privat_key, data.get().challenge)
                httpPostData('CloudM', 'validate_device', { username:document.getElementById('username').value, signature},
                    get_handleLoginError("signMessage"), handleLoginSuccessVD);
            }




        }

        return data
    }

    function loginDevice(username) {
        httpPostUrl('CloudM.AuthManager', 'get_to_sing_data', 'username='+username + '&personal_key='+checked[0].toString(), get_handleLoginError("loginDevice"), handleLoginSuccess);
    }

  document.getElementById('loginForm').addEventListener('submit', function(event) {
    event.preventDefault();

    let username = document.getElementById('username').value;
      loginDevice(username);
  });
 });
</script>

</body>
</html>
