<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COOS Kernel - Voice AI Assistant</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Color System - Cyberpunk meets Nature */
            --bg-primary: #050505;
            --bg-secondary: #0a0f0a;
            --bg-tertiary: #0f1610;
            --bg-card: rgba(16, 24, 18, 0.85);
            --bg-glass: rgba(16, 185, 129, 0.03);

            --accent-primary: #10b981;
            --accent-secondary: #34d399;
            --accent-tertiary: #6ee7b7;
            --accent-glow: rgba(16, 185, 129, 0.4);
            --accent-dim: rgba(16, 185, 129, 0.15);

            --text-primary: #f0fdf4;
            --text-secondary: #a7f3d0;
            --text-muted: #6b7280;
            --text-dim: #374151;

            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.4);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.4);

            --border-subtle: rgba(16, 185, 129, 0.12);
            --border-accent: rgba(16, 185, 129, 0.3);

            /* Typography */
            --font-display: 'Outfit', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 400ms ease;

            /* Effects */
            --shadow-glow: 0 0 40px var(--accent-glow);
            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.5);
        }

        .main-content {
            width: 100%; !important;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            max-width: 1200px; !important;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        /* Background Effect */
        .bg-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-effect::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse at 30% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(52, 211, 153, 0.05) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(16, 185, 129, 0.02) 0%, transparent 60%);
            animation: bgPulse 20s ease-in-out infinite;
        }

        .bg-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(16, 185, 129, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            mask-image: radial-gradient(ellipse at center, black 20%, transparent 70%);
        }

        @keyframes bgPulse {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-2%, -1%) scale(1.02); }
        }

        /* Main Layout */
        .app-container {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            gap: var(--space-md);
            padding: var(--space-md);
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            font-size: 0.875rem;
            font-family: var(--font-mono);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            box-shadow: 0 0 12px var(--accent-glow);
            animation: statusPulse 2s ease-in-out infinite;
        }

        .status-dot.disconnected {
            background: var(--danger);
            box-shadow: 0 0 12px var(--danger-glow);
        }

        .status-dot.processing {
            background: var(--warning);
            box-shadow: 0 0 12px var(--warning-glow);
            animation: statusBlink 0.5s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Sidebar - Config Panel */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-title {
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .panel-content {
            padding: var(--space-lg);
        }

        /* Voice Visualizer */
        .voice-visualizer {
            flex: 1;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-lg);
        }

        .visualizer-orb {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .orb-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px solid var(--accent-dim);
            opacity: 0.3;
            transition: all var(--transition-normal);
        }

        .orb-ring:nth-child(1) { width: 100%; height: 100%; }
        .orb-ring:nth-child(2) { width: 130%; height: 130%; }
        .orb-ring:nth-child(3) { width: 160%; height: 160%; }

        .visualizer-orb.active .orb-ring {
            border-color: var(--accent-primary);
            opacity: 0.6;
            animation: orbPulse 1.5s ease-in-out infinite;
        }

        .visualizer-orb.active .orb-ring:nth-child(2) { animation-delay: 0.2s; }
        .visualizer-orb.active .orb-ring:nth-child(3) { animation-delay: 0.4s; }

        .visualizer-orb.speaking .orb-ring {
            animation: orbSpeak 0.3s ease-in-out infinite alternate;
        }

        @keyframes orbPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.3; }
        }

        @keyframes orbSpeak {
            0% { transform: translate(-50%, -50%) scale(0.95); }
            100% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .orb-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            box-shadow:
                0 0 30px var(--accent-glow),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .orb-core:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow:
                0 0 50px var(--accent-glow),
                inset 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .orb-core.listening {
            background: linear-gradient(135deg, var(--danger), #f87171);
            box-shadow: 0 0 30px var(--danger-glow);
        }

        .visualizer-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
        }

        .visualizer-label span {
            display: block;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent-secondary);
            margin-top: var(--space-xs);
        }

        /* Audio Waveform */
        .waveform-container {
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: var(--space-md);
        }

        .waveform-bar {
            width: 4px;
            height: 20%;
            background: var(--accent-dim);
            border-radius: 2px;
            transition: height var(--transition-fast);
        }

        .waveform-bar.active {
            background: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        /* Wake Word Indicator */
        .wake-word-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            color: var(--text-muted);
            transition: all var(--transition-normal);
        }

        .wake-word-indicator.active {
            background: var(--accent-dim);
            border-color: var(--accent-primary);
            color: var(--accent-secondary);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .wake-word-indicator .icon {
            font-size: 1rem;
        }

        /* Main Chat Area */
        .main-content {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .chat-title {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .chat-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 1rem;
        }

        .btn-icon:hover {
            background: var(--accent-dim);
            border-color: var(--accent-primary);
            color: var(--accent-secondary);
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            scroll-behavior: smooth;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: var(--space-md);
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .message.user .message-avatar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .message-bubble {
            padding: var(--space-md) var(--space-lg);
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.assistant .message-bubble {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .message.user .message-meta {
            justify-content: flex-end;
        }

        .message-type-badge {
            padding: 2px 8px;
            background: var(--bg-glass);
            border-radius: 4px;
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .message.user .message-type-badge.voice {
            background: rgba(255, 255, 255, 0.2);
            color: var(--bg-primary);
        }

        /* System Message */
        .message.system {
            justify-content: center;
        }

        .message.system .message-bubble {
            max-width: 80%;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            gap: var(--space-md);
            padding: var(--space-md) 0;
        }

        .typing-indicator.visible {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typingDot 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* Chat Input */
        .chat-input-container {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
        }

        .chat-input-wrapper {
            display: flex;
            gap: var(--space-md);
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            transition: all var(--transition-fast);
        }

        .chat-input:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .chat-input input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 1rem;
        }

        .chat-input input::placeholder {
            color: var(--text-dim);
        }

        .btn-send {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 14px;
            color: var(--bg-primary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .btn-send:active {
            transform: translateY(0);
        }

        .btn-voice {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-voice:hover {
            background: var(--accent-dim);
            border-color: var(--accent-primary);
            color: var(--accent-secondary);
        }

        .btn-voice.recording {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--danger-glow); }
            50% { box-shadow: 0 0 0 8px transparent; }
        }

        /* Config Panel (Right Sidebar) */
        .config-panel {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .config-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .config-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Toggle Switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toggle.active {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
        }

        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle.active .toggle-knob {
            left: calc(100% - 22px);
        }

        /* Select Dropdown */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper select {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 0.875rem;
            cursor: pointer;
            appearance: none;
            transition: all var(--transition-fast);
        }

        .select-wrapper select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .select-wrapper::after {
            content: '‚ñº';
            position: absolute;
            right: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.625rem;
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Slider */
        .slider-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-value {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent-secondary);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: all var(--transition-fast);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Tags Input */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            padding: var(--space-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            min-height: 40px;
        }

        .tag {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 4px 10px;
            background: var(--accent-dim);
            border: 1px solid var(--accent-primary);
            border-radius: 100px;
            font-size: 0.75rem;
            color: var(--accent-secondary);
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity var(--transition-fast);
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Transcription Preview */
        .transcription-preview {
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 0.875rem;
            color: var(--text-muted);
            min-height: 60px;
            font-style: italic;
        }

        .transcription-preview.active {
            border-color: var(--accent-primary);
            color: var(--text-secondary);
            font-style: normal;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            z-index: 1000;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-card);
            animation: toastIn 0.3s ease-out;
            max-width: 400px;
        }

        .toast.success {
            border-color: var(--accent-primary);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon { color: var(--accent-primary); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .toast-message {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .toast-close {
            cursor: pointer;
            color: var(--text-muted);
            transition: color var(--transition-fast);
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loader-overlay.visible {
            display: flex;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-lg);
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar, .config-panel {
                order: 3;
            }

            .main-content {
                order: 2;
                min-height: 60vh;
            }

            .header {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: var(--space-sm);
                gap: var(--space-sm);
            }

            .header {
                flex-direction: column;
                gap: var(--space-md);
                text-align: center;
            }

            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="bg-effect">
        <div class="bg-grid"></div>
    </div>

    <!-- Loader Overlay -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader">
            <div class="loader-spinner"></div>
            <div class="loader-text">Connecting to COOS Kernel...</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üß†</div>
                <div>
                    <div class="logo-text">COOS Kernel</div>
                    <div class="logo-subtitle">Voice AI Assistant</div>
                </div>
            </div>
            <div class="header-status">
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
                <div class="status-badge">
                    <span>üé§</span>
                    <span id="voiceStatus">Ready</span>
                </div>
            </div>
        </header>

        <!-- Left Sidebar - Voice Control -->
        <aside class="sidebar">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Voice Control</span>
                </div>
                <div class="panel-content voice-visualizer">
                    <div class="visualizer-orb" id="visualizerOrb">
                        <div class="orb-ring"></div>
                        <div class="orb-ring"></div>
                        <div class="orb-ring"></div>
                        <div class="orb-core" id="orbCore" title="Click to toggle voice">
                            üéôÔ∏è
                        </div>
                    </div>
                    <div class="visualizer-label">
                        <span id="voiceStateLabel">Click to start listening</span>
                        <span id="voiceStateDetail"></span>
                    </div>
                    <div class="wake-word-indicator" id="wakeWordIndicator">
                        <span class="icon">üëÇ</span>
                        <span id="wakeWordText">Wake word: "Hey COOS"</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Audio Level</span>
                </div>
                <div class="panel-content">
                    <div class="waveform-container" id="waveformContainer">
                        <!-- Generated by JS -->
                    </div>
                    <div class="transcription-preview" id="transcriptionPreview">
                        Transcription will appear here...
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <div class="chat-header">
                <span class="chat-title">üí¨ Conversation</span>
                <div class="chat-actions">
                    <button class="btn-icon" id="btnClear" title="Clear chat">üóëÔ∏è</button>
                    <button class="btn-icon" id="btnExport" title="Export chat">üì•</button>
                    <button class="btn-icon" id="btnSettings" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="message system">
                    <div class="message-bubble">
                        Welcome to COOS Kernel! I'm your voice AI assistant. You can type or speak to me.
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">üß†</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <button class="btn-voice" id="btnVoice" title="Voice input">
                        üé§
                    </button>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type your message or press the mic button..." autocomplete="off">
                    </div>
                    <button class="btn-send" id="btnSend" title="Send message">
                        ‚û§
                    </button>
                </div>
            </div>
        </main>

        <!-- Right Sidebar - Configuration -->
        <aside class="config-panel">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Voice Settings</span>
                </div>
                <div class="panel-content config-section">
                    <div class="config-item">
                        <div class="toggle-wrapper">
                            <span class="config-label">Voice Enabled</span>
                            <div class="toggle active" id="toggleVoice" data-setting="voice.enabled">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>

                    <div class="config-item">
                        <div class="toggle-wrapper">
                            <span class="config-label">Wake Word</span>
                            <div class="toggle active" id="toggleWakeWord" data-setting="voice.wake_word_enabled">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>

                    <div class="config-item">
                        <div class="toggle-wrapper">
                            <span class="config-label">VAD (Voice Detection)</span>
                            <div class="toggle active" id="toggleVAD" data-setting="voice.vad_enabled">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>

                    <div class="config-item">
                        <div class="toggle-wrapper">
                            <span class="config-label">Auto-Speak Response</span>
                            <div class="toggle active" id="toggleAutoSpeak" data-setting="voice.auto_speak_response">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>

                    <div class="config-item slider-wrapper">
                        <div class="slider-header">
                            <span class="config-label">VAD Sensitivity</span>
                            <span class="slider-value" id="vadSensitivityValue">50%</span>
                        </div>
                        <input type="range" min="0" max="100" value="50" id="vadSensitivity" data-setting="voice.vad_sensitivity">
                    </div>

                    <div class="config-item">
                        <span class="config-label">TTS Voice</span>
                        <div class="select-wrapper">
                            <select id="ttsVoice" data-setting="voice.tts_voice">
                                <option value="alloy">Alloy (Neutral)</option>
                                <option value="echo">Echo (Male)</option>
                                <option value="fable">Fable (Expressive)</option>
                                <option value="onyx">Onyx (Deep)</option>
                                <option value="nova">Nova (Female)</option>
                                <option value="shimmer">Shimmer (Soft)</option>
                            </select>
                        </div>
                    </div>

                    <div class="config-item">
                        <span class="config-label">Language</span>
                        <div class="select-wrapper">
                            <select id="language" data-setting="voice.language">
                                <option value="de">Deutsch</option>
                                <option value="en">English</option>
                                <option value="es">Espa√±ol</option>
                                <option value="fr">Fran√ßais</option>
                                <option value="it">Italiano</option>
                                <option value="ja">Êó•Êú¨Ë™û</option>
                                <option value="zh">‰∏≠Êñá</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Wake Words</span>
                </div>
                <div class="panel-content config-section">
                    <div class="tags-container" id="wakeWordsContainer">
                        <div class="tag">
                            <span>hey coos</span>
                            <span class="tag-remove" data-word="hey coos">√ó</span>
                        </div>
                        <div class="tag">
                            <span>coos</span>
                            <span class="tag-remove" data-word="coos">√ó</span>
                        </div>
                    </div>
                    <div class="chat-input" style="margin-top: var(--space-sm);">
                        <input type="text" id="newWakeWord" placeholder="Add wake word...">
                        <button class="btn-icon" id="btnAddWakeWord" style="width: 28px; height: 28px; font-size: 0.875rem;">+</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">General Settings</span>
                </div>
                <div class="panel-content config-section">
                    <div class="config-item">
                        <span class="config-label">Theme</span>
                        <div class="select-wrapper">
                            <select id="theme" data-setting="theme">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                    </div>

                    <div class="config-item">
                        <span class="config-label">Response Style</span>
                        <div class="select-wrapper">
                            <select id="responseStyle" data-setting="response_style">
                                <option value="balanced">Balanced</option>
                                <option value="concise">Concise</option>
                                <option value="detailed">Detailed</option>
                            </select>
                        </div>
                    </div>

                    <div class="config-item">
                        <div class="toggle-wrapper">
                            <span class="config-label">Notifications</span>
                            <div class="toggle active" id="toggleNotifications" data-setting="notifications_enabled">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script unSave="ture">
        // ========== COOS Kernel Client ==========

        class COOSKernel {
            constructor() {
                this.ws = null;
                this.sessionId = this.getOrCreateSessionId();
                this.config = {};
                this.isConnected = false;
                this.isRecording = false;
                this.isListening = false;
                this.wakeWordActive = false;

                // Audio recording
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.audioContext = null;
                this.analyser = null;
                this.audioStream = null;

                // Audio playback
                this.audioQueue = [];
                this.isPlaying = false;

                // VAD
                this.vadSilenceTimeout = null;
                this.vadSpeaking = false;

                // UI Elements
                this.elements = {};

                // Initialize
                this.init();
            }

            getOrCreateSessionId() {
                let sessionId = localStorage.getItem('coos_session_id');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('coos_session_id', sessionId);
                }
                return sessionId;
            }

            init() {
                this.cacheElements();
                this.generateWaveformBars();
                this.bindEvents();
                this.connect();
            }

            cacheElements() {
                this.elements = {
                    loaderOverlay: document.getElementById('loaderOverlay'),
                    toastContainer: document.getElementById('toastContainer'),
                    statusDot: document.getElementById('statusDot'),
                    statusText: document.getElementById('statusText'),
                    voiceStatus: document.getElementById('voiceStatus'),
                    visualizerOrb: document.getElementById('visualizerOrb'),
                    orbCore: document.getElementById('orbCore'),
                    voiceStateLabel: document.getElementById('voiceStateLabel'),
                    voiceStateDetail: document.getElementById('voiceStateDetail'),
                    wakeWordIndicator: document.getElementById('wakeWordIndicator'),
                    wakeWordText: document.getElementById('wakeWordText'),
                    waveformContainer: document.getElementById('waveformContainer'),
                    transcriptionPreview: document.getElementById('transcriptionPreview'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    typingIndicator: document.getElementById('typingIndicator'),
                    messageInput: document.getElementById('messageInput'),
                    btnSend: document.getElementById('btnSend'),
                    btnVoice: document.getElementById('btnVoice'),
                    btnClear: document.getElementById('btnClear'),
                    btnExport: document.getElementById('btnExport'),
                    btnSettings: document.getElementById('btnSettings'),
                    wakeWordsContainer: document.getElementById('wakeWordsContainer'),
                    newWakeWord: document.getElementById('newWakeWord'),
                    btnAddWakeWord: document.getElementById('btnAddWakeWord'),
                    vadSensitivity: document.getElementById('vadSensitivity'),
                    vadSensitivityValue: document.getElementById('vadSensitivityValue')
                };
            }

            generateWaveformBars() {
                const container = this.elements.waveformContainer;
                container.innerHTML = '';
                for (let i = 0; i < 32; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'waveform-bar';
                    container.appendChild(bar);
                }
            }

            bindEvents() {
                // Send message
                this.elements.btnSend.addEventListener('click', () => this.sendMessage());
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                // Voice button
                this.elements.btnVoice.addEventListener('click', () => this.toggleRecording());
                this.elements.orbCore.addEventListener('click', () => this.toggleListening());

                // Clear chat
                this.elements.btnClear.addEventListener('click', () => this.clearChat());

                // Export chat
                this.elements.btnExport.addEventListener('click', () => this.exportChat());

                // Toggle switches
                document.querySelectorAll('.toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        this.updateConfigFromUI();
                    });
                });

                // Selects and sliders
                document.querySelectorAll('select, input[type="range"]').forEach(input => {
                    input.addEventListener('change', () => this.updateConfigFromUI());
                });

                // VAD Sensitivity display
                this.elements.vadSensitivity.addEventListener('input', (e) => {
                    this.elements.vadSensitivityValue.textContent = e.target.value + '%';
                });

                // Wake word management
                this.elements.btnAddWakeWord.addEventListener('click', () => this.addWakeWord());
                this.elements.newWakeWord.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addWakeWord();
                });

                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tag-remove')) {
                        this.removeWakeWord(e.target.dataset.word);
                    }
                });
            }

            // ===== WebSocket Connection =====

            connect() {
                this.showLoader(true);

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/KernelCOOS/kernel`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                    this.showLoader(false);
                };

                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);

                    // Reconnect after 3 seconds
                    setTimeout(() => this.connect(), 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.showToast('Connection Error', 'Failed to connect to server', 'error');
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {
                        console.error('Failed to parse message:', e);
                    }
                };
            }

            send(event, data = {}) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ event, data }));
                }
            }

            handleMessage(message) {
                const { event, data } = message;

                switch (event) {
                    case 'welcome':
                        this.handleWelcome(data);
                        break;
                    case 'agent_response':
                        this.handleAgentResponse(data);
                        break;
                    case 'transcription':
                        this.handleTranscription(data);
                        break;
                    case 'tts_audio':
                        this.handleTTSAudio(data);
                        break;
                    case 'vad_start':
                        this.handleVADStart();
                        break;
                    case 'vad_end':
                        this.handleVADEnd();
                        break;
                    case 'wake_word':
                        this.handleWakeWord(data);
                        break;
                    case 'intermediate':
                        this.handleIntermediate(data);
                        break;
                    case 'notification':
                        this.handleNotification(data);
                        break;
                    case 'error':
                        this.handleError(data);
                        break;
                    case 'config_updated':
                        this.handleConfigUpdated(data);
                        break;
                    case 'pong':
                        // Heartbeat response
                        break;
                    default:
                        console.log('Unknown event:', event, data);
                }
            }

            // ===== Message Handlers =====

            handleWelcome(data) {
                console.log('Welcome:', data);
                this.config = data.config || {};
                this.applyConfigToUI(this.config);
                this.showToast('Connected', data.message, 'success');

                // Update capabilities
                if (data.capabilities) {
                    this.updateCapabilities(data.capabilities);
                }
            }

            handleAgentResponse(data) {
                this.hideTypingIndicator();
                this.addMessage('assistant', data.content, data.metadata);
            }

            handleTranscription(data) {
                this.elements.transcriptionPreview.textContent = data.text;
                this.elements.transcriptionPreview.classList.add('active');

                if (data.is_final) {
                    // Add user message for voice input
                    this.addMessage('user', data.text, { type: 'voice' });
                    this.showTypingIndicator();

                    // Clear preview after a moment
                    setTimeout(() => {
                        this.elements.transcriptionPreview.textContent = 'Transcription will appear here...';
                        this.elements.transcriptionPreview.classList.remove('active');
                    }, 2000);
                }
            }

            handleTTSAudio(data) {
                // Decode and play audio
                const audioData = atob(data.audio);
                const arrayBuffer = new ArrayBuffer(audioData.length);
                const view = new Uint8Array(arrayBuffer);
                for (let i = 0; i < audioData.length; i++) {
                    view[i] = audioData.charCodeAt(i);
                }

                const blob = new Blob([arrayBuffer], { type: 'audio/mp3' });
                const audioUrl = URL.createObjectURL(blob);

                this.playAudio(audioUrl);
            }

            handleVADStart() {
                this.vadSpeaking = true;
                this.elements.visualizerOrb.classList.add('speaking');
                this.elements.voiceStatus.textContent = 'Listening...';
            }

            handleVADEnd() {
                this.vadSpeaking = false;
                this.elements.visualizerOrb.classList.remove('speaking');
                this.elements.voiceStatus.textContent = 'Processing...';
            }

            handleWakeWord(data) {
                this.wakeWordActive = data.activated;
                this.elements.wakeWordIndicator.classList.toggle('active', data.activated);

                if (data.activated) {
                    this.showToast('Wake Word', `Activated: "${data.wake_word}"`, 'success');
                    this.elements.wakeWordText.textContent = `Active (${data.wake_word})`;
                } else {
                    this.elements.wakeWordText.textContent = 'Wake word: "Hey COOS"';
                }
            }

            handleIntermediate(data) {
                // Show intermediate processing status
                this.showTypingIndicator();
                console.log('Processing:', data.stage, data.content);
            }

            handleNotification(data) {
                this.showToast('Notification', data.content, data.priority >= 7 ? 'warning' : 'success');
            }

            handleError(data) {
                this.showToast('Error', data.error, 'error');
                this.hideTypingIndicator();
            }

            handleConfigUpdated(data) {
                this.config = data;
                this.applyConfigToUI(this.config);
                this.showToast('Settings', 'Configuration updated', 'success');
            }

            // ===== UI Actions =====

            sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (!message) return;

                this.addMessage('user', message, { type: 'text' });
                this.send('chat', { message });
                this.elements.messageInput.value = '';
                this.showTypingIndicator();
            }

            addMessage(role, content, metadata = {}) {
                const container = this.elements.messagesContainer;
                const messageEl = document.createElement('div');
                messageEl.className = `message ${role}`;

                const avatar = role === 'assistant' ? 'üß†' : 'üë§';
                const typeLabel = metadata.type === 'voice' ? '<span class="message-type-badge voice">üé§ Voice</span>' : '';
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                messageEl.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-bubble">${this.escapeHtml(content)}</div>
                        <div class="message-meta">
                            ${typeLabel}
                            <span>${time}</span>
                        </div>
                    </div>
                `;

                container.appendChild(messageEl);
                container.scrollTop = container.scrollHeight;
            }

            showTypingIndicator() {
                this.elements.typingIndicator.classList.add('visible');
            }

            hideTypingIndicator() {
                this.elements.typingIndicator.classList.remove('visible');
            }

            clearChat() {
                const container = this.elements.messagesContainer;
                container.innerHTML = `
                    <div class="message system">
                        <div class="message-bubble">Chat cleared. Start a new conversation!</div>
                    </div>
                `;
            }

            exportChat() {
                const messages = this.elements.messagesContainer.querySelectorAll('.message:not(.system)');
                let exportText = 'COOS Kernel Chat Export\n';
                exportText += '========================\n\n';

                messages.forEach(msg => {
                    const role = msg.classList.contains('user') ? 'User' : 'Assistant';
                    const content = msg.querySelector('.message-bubble').textContent;
                    const time = msg.querySelector('.message-meta span:last-child')?.textContent || '';
                    exportText += `[${time}] ${role}: ${content}\n\n`;
                });

                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `coos-chat-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);

                this.showToast('Export', 'Chat exported successfully', 'success');
            }

            // ===== Voice Recording =====

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async toggleListening() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    await this.startListening();
                }
            }

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioStream = stream;

                    // Setup audio analyser for visualization
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = this.audioContext.createMediaStreamSource(stream);
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 64;
                    source.connect(this.analyser);

                    // Setup media recorder
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    this.audioChunks = [];

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            this.audioChunks.push(e.data);
                        }
                    };

                    this.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        await this.processAndSendAudio(audioBlob);
                    };

                    this.mediaRecorder.start(100); // Capture in 100ms chunks
                    this.isRecording = true;

                    this.elements.btnVoice.classList.add('recording');
                    this.elements.voiceStatus.textContent = 'Recording...';

                    // Start visualization
                    this.visualizeAudio();

                } catch (error) {
                    console.error('Failed to start recording:', error);
                    this.showToast('Error', 'Could not access microphone', 'error');
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;

                    this.elements.btnVoice.classList.remove('recording');
                    this.elements.voiceStatus.textContent = 'Processing...';

                    // Stop stream
                    if (this.audioStream) {
                        this.audioStream.getTracks().forEach(track => track.stop());
                    }

                    // Reset waveform
                    this.resetWaveform();
                }
            }

            async startListening() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioStream = stream;

                    // Setup audio context
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = this.audioContext.createMediaStreamSource(stream);
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    source.connect(this.analyser);

                    // Setup script processor for continuous audio processing
                    const scriptProcessor = this.audioContext.createScriptProcessor(4096, 1, 1);
                    source.connect(scriptProcessor);
                    scriptProcessor.connect(this.audioContext.destination);

                    scriptProcessor.onaudioprocess = (e) => {
                        if (!this.isListening) return;

                        const inputData = e.inputBuffer.getChannelData(0);
                        const int16Data = this.floatTo16BitPCM(inputData);
                        const base64Audio = this.arrayBufferToBase64(int16Data.buffer);

                        // Send audio data to server for VAD processing
                        this.send('audio_data', { audio: base64Audio });
                    };

                    this.isListening = true;
                    this.elements.orbCore.classList.add('listening');
                    this.elements.visualizerOrb.classList.add('active');
                    this.elements.voiceStateLabel.textContent = 'Listening...';
                    this.elements.voiceStatus.textContent = 'Active';

                    // Start visualization
                    this.visualizeAudio();

                } catch (error) {
                    console.error('Failed to start listening:', error);
                    this.showToast('Error', 'Could not access microphone', 'error');
                }
            }

            stopListening() {
                this.isListening = false;

                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                }

                if (this.audioContext) {
                    this.audioContext.close();
                }

                this.elements.orbCore.classList.remove('listening');
                this.elements.visualizerOrb.classList.remove('active', 'speaking');
                this.elements.voiceStateLabel.textContent = 'Click to start listening';
                this.elements.voiceStatus.textContent = 'Ready';

                this.resetWaveform();
            }

            async processAndSendAudio(audioBlob) {
                try {
                    // Convert to base64 and send
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        this.send('audio_data', { audio: base64Audio });
                    };
                    reader.readAsDataURL(audioBlob);

                } catch (error) {
                    console.error('Failed to process audio:', error);
                    this.elements.voiceStatus.textContent = 'Ready';
                }
            }

            visualizeAudio() {
                if (!this.analyser || (!this.isRecording && !this.isListening)) return;

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                this.analyser.getByteFrequencyData(dataArray);

                const bars = this.elements.waveformContainer.querySelectorAll('.waveform-bar');
                const step = Math.floor(bufferLength / bars.length);

                bars.forEach((bar, i) => {
                    const value = dataArray[i * step] || 0;
                    const height = Math.max(20, (value / 255) * 100);
                    bar.style.height = height + '%';
                    bar.classList.toggle('active', value > 50);
                });

                requestAnimationFrame(() => this.visualizeAudio());
            }

            resetWaveform() {
                const bars = this.elements.waveformContainer.querySelectorAll('.waveform-bar');
                bars.forEach(bar => {
                    bar.style.height = '20%';
                    bar.classList.remove('active');
                });
            }

            // ===== Audio Playback =====

            playAudio(audioUrl) {
                this.audioQueue.push(audioUrl);
                if (!this.isPlaying) {
                    this.playNextAudio();
                }
            }

            playNextAudio() {
                if (this.audioQueue.length === 0) {
                    this.isPlaying = false;
                    this.elements.voiceStatus.textContent = 'Ready';
                    return;
                }

                this.isPlaying = true;
                this.elements.voiceStatus.textContent = 'Speaking...';
                this.elements.visualizerOrb.classList.add('speaking');

                const audioUrl = this.audioQueue.shift();
                const audio = new Audio(audioUrl);

                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    this.elements.visualizerOrb.classList.remove('speaking');
                    this.playNextAudio();
                };

                audio.onerror = () => {
                    console.error('Audio playback error');
                    this.playNextAudio();
                };

                audio.play();
            }

            // ===== Configuration =====

            updateConfigFromUI() {
                const config = {
                    voice: {
                        enabled: document.getElementById('toggleVoice').classList.contains('active'),
                        wake_word_enabled: document.getElementById('toggleWakeWord').classList.contains('active'),
                        vad_enabled: document.getElementById('toggleVAD').classList.contains('active'),
                        auto_speak_response: document.getElementById('toggleAutoSpeak').classList.contains('active'),
                        vad_sensitivity: parseInt(document.getElementById('vadSensitivity').value) / 100,
                        tts_voice: document.getElementById('ttsVoice').value,
                        language: document.getElementById('language').value
                    },
                    theme: document.getElementById('theme').value,
                    response_style: document.getElementById('responseStyle').value,
                    notifications_enabled: document.getElementById('toggleNotifications').classList.contains('active')
                };

                this.send('config_update', config);
            }

            applyConfigToUI(config) {
                if (!config) return;

                // Voice settings
                if (config.voice) {
                    this.setToggle('toggleVoice', config.voice.enabled);
                    this.setToggle('toggleWakeWord', config.voice.wake_word_enabled);
                    this.setToggle('toggleVAD', config.voice.vad_enabled);
                    this.setToggle('toggleAutoSpeak', config.voice.auto_speak_response);

                    document.getElementById('vadSensitivity').value = (config.voice.vad_sensitivity || 0.5) * 100;
                    this.elements.vadSensitivityValue.textContent = Math.round((config.voice.vad_sensitivity || 0.5) * 100) + '%';

                    if (config.voice.tts_voice) {
                        document.getElementById('ttsVoice').value = config.voice.tts_voice;
                    }
                    if (config.voice.language) {
                        document.getElementById('language').value = config.voice.language;
                    }

                    // Wake words
                    if (config.voice.wake_words) {
                        this.updateWakeWordsUI(config.voice.wake_words);
                    }
                }

                // General settings
                if (config.theme) {
                    document.getElementById('theme').value = config.theme;
                }
                if (config.response_style) {
                    document.getElementById('responseStyle').value = config.response_style;
                }
                this.setToggle('toggleNotifications', config.notifications_enabled !== false);
            }

            setToggle(id, value) {
                const toggle = document.getElementById(id);
                if (toggle) {
                    toggle.classList.toggle('active', value);
                }
            }

            updateWakeWordsUI(wakeWords) {
                const container = this.elements.wakeWordsContainer;
                container.innerHTML = '';

                wakeWords.forEach(word => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.innerHTML = `
                        <span>${this.escapeHtml(word)}</span>
                        <span class="tag-remove" data-word="${this.escapeHtml(word)}">√ó</span>
                    `;
                    container.appendChild(tag);
                });
            }

            addWakeWord() {
                const input = this.elements.newWakeWord;
                const word = input.value.trim().toLowerCase();

                if (!word) return;

                // Get current wake words
                const currentWords = this.config.voice?.wake_words || [];
                if (!currentWords.includes(word)) {
                    currentWords.push(word);
                    this.updateWakeWordsUI(currentWords);

                    // Update config
                    this.send('config_update', {
                        voice: { wake_words: currentWords }
                    });
                }

                input.value = '';
            }

            removeWakeWord(word) {
                const currentWords = this.config.voice?.wake_words || [];
                const index = currentWords.indexOf(word);
                if (index > -1) {
                    currentWords.splice(index, 1);
                    this.updateWakeWordsUI(currentWords);

                    // Update config
                    this.send('config_update', {
                        voice: { wake_words: currentWords }
                    });
                }
            }

            updateCapabilities(capabilities) {
                if (!capabilities.voice_enabled) {
                    this.elements.btnVoice.disabled = true;
                    this.elements.btnVoice.title = 'Voice input not available';
                }
            }

            // ===== UI Helpers =====

            updateConnectionStatus(connected) {
                this.elements.statusDot.classList.toggle('disconnected', !connected);
                this.elements.statusText.textContent = connected ? 'Connected' : 'Disconnected';
            }

            showLoader(show) {
                this.elements.loaderOverlay.classList.toggle('visible', show);
            }

            showToast(title, message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                const icons = {
                    success: '‚úì',
                    error: '‚úï',
                    warning: '‚ö†'
                };

                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <div class="toast-content">
                        <div class="toast-title">${this.escapeHtml(title)}</div>
                        <div class="toast-message">${this.escapeHtml(message)}</div>
                    </div>
                    <span class="toast-close">√ó</span>
                `;

                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });

                this.elements.toastContainer.appendChild(toast);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.style.animation = 'toastIn 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // ===== Utility Functions =====

            floatTo16BitPCM(float32Array) {
                const int16Array = new Int16Array(float32Array.length);
                for (let i = 0; i < float32Array.length; i++) {
                    const s = Math.max(-1, Math.min(1, float32Array[i]));
                    int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                return int16Array;
            }

            arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }
        }

        // Initialize when DOM is ready
        window.TB.onLoaded(() => {
            window.coosKernel = new COOSKernel();
        });
    </script>
</body>
</html>
