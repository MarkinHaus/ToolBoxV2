name: Release

on:
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "lts/*"

jobs:
  # ============================================================================
  # FRONTEND BUILD
  # ============================================================================

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and Build
        working-directory: toolboxv2
        run: |
          npm install
          npm install --prefix ./tbjs
          npm install --prefix ./web
          npm run build:tbjs && npm run build:web

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: toolboxv2/dist

  # ============================================================================
  # TBLANG COMPILER BUILD (only if "tbx" in tag)
  # ============================================================================

  check-tblang:
    name: Check TBLang Build Flag
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.eval.outputs.should_build }}
    steps:
      - name: Evaluate Tag
        id: eval
        run: |
          tag="${{ github.event.release.tag_name }}"
          if [[ "$tag" == *"tbx"* ]] || [[ "$tag" == *"TBX"* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-tblang:
    name: TBLang (${{ matrix.os }})
    needs: check-tblang
    if: needs.check-tblang.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: tblang-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: tblang-windows-x64.exe
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: tblang-macos-arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build TBLang
        working-directory: ./toolboxv2/tb-exc/src
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package Artifact
        shell: bash
        run: |
          mkdir -p artifacts
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            find ./toolboxv2/tb-exc/src/target/${{ matrix.target }}/release -maxdepth 1 -name "*.exe" -type f | head -1 | xargs -I {} cp {} artifacts/${{ matrix.artifact_name }}
          else
            find ./toolboxv2/tb-exc/src/target/${{ matrix.target }}/release -maxdepth 1 -type f -perm +111 ! -name "*.d" | head -1 | xargs -I {} cp {} artifacts/${{ matrix.artifact_name }} || true
            chmod +x artifacts/${{ matrix.artifact_name }} 2>/dev/null || true
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/*

  # ============================================================================
  # BROWSER EXTENSION BUILD
  # ============================================================================

  build-browser-extension:
    name: Browser Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for Extension
        id: check
        run: |
          if [ -f "./toolboxv2/tb_browser/build.js" ] || [ -d "./toolboxv2/tb_browser" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build Extension
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/tb_browser
        run: |
          npm install || true
          if [ -f "build.js" ]; then
            node build.js zip
          elif [ -f "package.json" ]; then
            npm run build || true
          fi

      - name: Package Extension
        if: steps.check.outputs.exists == 'true'
        run: |
          mkdir -p artifacts
          cd ./toolboxv2/tb_browser
          if [ -d "dist" ]; then
            zip -r ../../artifacts/tb-browser-extension.zip dist/
          elif [ -d "build" ]; then
            zip -r ../../artifacts/tb-browser-extension.zip build/
          fi

      - name: Upload Artifact
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: browser-extension
          path: artifacts/*

  # ============================================================================
  # NUITKA BUILD (Python Standalone)
  # ============================================================================

  build-nuitka:
    name: Nuitka (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: toolbox-linux-x64
          - os: windows-latest
            artifact_name: toolbox-windows-x64.exe
          - os: macos-latest
            artifact_name: toolbox-macos-arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: toolboxv2/__main__.py
          mode: onefile
          output-dir: build
          include-package: toolboxv2
          assume-yes-for-downloads: true

      - name: Package Artifact
        shell: bash
        run: |
          mkdir -p artifacts
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp build/__main__.exe artifacts/${{ matrix.artifact_name }}
          else
            cp build/__main__.bin artifacts/${{ matrix.artifact_name }} 2>/dev/null || cp build/__main__ artifacts/${{ matrix.artifact_name }} || true
            chmod +x artifacts/${{ matrix.artifact_name }} 2>/dev/null || true
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/*

  # ============================================================================
  # TAURI DESKTOP BUILDS
  # ============================================================================

  check-tauri:
    name: Check Tauri Build Flag
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.eval.outputs.should_build }}
    steps:
      - name: Evaluate Tag
        id: eval
        run: |
          tag="${{ github.event.release.tag_name }}"
          if [[ "$tag" == *"App"* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-tauri:
    name: Tauri (${{ matrix.platform }})
    needs: [check-tauri, build-frontend]
    if: needs.check-tauri.outputs.should_build == 'true'
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
            artifact_name: simple-core-macos-arm64
            target_triple: aarch64-apple-darwin
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'
            artifact_name: simple-core-macos-x64
            target_triple: x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ''
            artifact_name: simple-core-linux-x64
            target_triple: x86_64-unknown-linux-gnu
          - platform: windows-latest
            args: ''
            artifact_name: simple-core-windows-x64
            target_triple: x86_64-pc-windows-msvc
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Ubuntu Dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libxdo-dev

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create Worker Binary
        shell: bash
        run: |
          mkdir -p ./toolboxv2/simple-core/src-tauri/binaries

          # Install ToolBoxV2 and PyInstaller
          pip install pyinstaller
          pip install -e . || pip install .

          # Use the real tauri_integration.py as entry point
          WORKER_ENTRY="./toolboxv2/utils/workers/tauri_integration.py"

          # Build with PyInstaller including all ToolBoxV2 dependencies
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            pyinstaller --onefile \
              --name "tb-worker-${{ matrix.target_triple }}" \
              --console \
              --collect-all toolboxv2 \
              --hidden-import toolboxv2.utils.workers \
              --hidden-import toolboxv2.utils.workers.server_worker \
              --hidden-import toolboxv2.utils.workers.ws_worker \
              --hidden-import toolboxv2.utils.workers.config \
              --hidden-import toolboxv2.utils.workers.session \
              --hidden-import toolboxv2.utils.workers.event_manager \
              --hidden-import toolboxv2.utils.system.getting_and_closing_app \
              "$WORKER_ENTRY"
            cp dist/tb-worker-${{ matrix.target_triple }}.exe ./toolboxv2/simple-core/src-tauri/binaries/
          else
            pyinstaller --onefile \
              --name "tb-worker-${{ matrix.target_triple }}" \
              --collect-all toolboxv2 \
              --hidden-import toolboxv2.utils.workers \
              --hidden-import toolboxv2.utils.workers.server_worker \
              --hidden-import toolboxv2.utils.workers.ws_worker \
              --hidden-import toolboxv2.utils.workers.config \
              --hidden-import toolboxv2.utils.workers.session \
              --hidden-import toolboxv2.utils.workers.event_manager \
              --hidden-import toolboxv2.utils.system.getting_and_closing_app \
              "$WORKER_ENTRY"
            cp dist/tb-worker-${{ matrix.target_triple }} ./toolboxv2/simple-core/src-tauri/binaries/
            chmod +x ./toolboxv2/simple-core/src-tauri/binaries/tb-worker-${{ matrix.target_triple }}
          fi

          # Verify the binary was created
          ls -la ./toolboxv2/simple-core/src-tauri/binaries/

      - name: Update Cargo Dependencies
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: cargo update

      - name: Install Frontend Dependencies
        working-directory: ./toolboxv2
        run: |
          npm install
          npm install --prefix ./web
          cd simple-core && npm install && cd ..
          npm run build

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: ./toolboxv2/simple-core
          tauriScript: npx tauri
          args: ${{ matrix.args }}

      - name: Package Artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          find ./toolboxv2/simple-core/src-tauri/target -name "*.dmg" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ./toolboxv2/simple-core/src-tauri/target -name "*.msi" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ./toolboxv2/simple-core/src-tauri/target -name "*.deb" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ./toolboxv2/simple-core/src-tauri/target -name "*.AppImage" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ./toolboxv2/simple-core/src-tauri/target -name "*.app.tar.gz" -exec cp {} artifacts/ \; 2>/dev/null || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/*

  # ============================================================================
  # ANDROID BUILD
  # ============================================================================

  build-android:
    name: Android APK
    needs: [check-tauri, build-frontend]
    if: needs.check-tauri.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Update Cargo Dependencies
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: cargo update

      - name: Install Frontend Dependencies
        working-directory: ./toolboxv2
        run: |
          npm install
          npm install --prefix ./web
          cd simple-core && npm install && cd ..
          npm run build

      - name: Remove externalBin for Mobile
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: |
          python3 -c "
          import json
          with open('tauri.conf.json', 'r') as f:
              config = json.load(f)
          if 'bundle' in config and 'externalBin' in config['bundle']:
              del config['bundle']['externalBin']
          with open('tauri.conf.json', 'w') as f:
              json.dump(config, f, indent=2)
          "

      - name: Clean Android Build Cache
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: |
          rm -rf gen/android
          rm -rf target/aarch64-linux-android
          rm -rf target/armv7-linux-androideabi
          rm -rf target/x86_64-linux-android
          rm -rf target/i686-linux-android

      - name: Build Android
        working-directory: ./toolboxv2/simple-core
        run: |
          cargo tauri android init
          cargo tauri android build --apk || cargo tauri android build

      - name: Package Artifacts
        run: |
          mkdir -p artifacts
          find ./toolboxv2/simple-core -name "*.apk" -exec cp {} artifacts/ \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts/*.apk

  # ============================================================================
  # iOS BUILD
  # ============================================================================

  build-ios:
    name: iOS Build
    needs: [check-tauri, build-frontend]
    if: needs.check-tauri.outputs.should_build == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2"

      - name: Update Cargo Dependencies
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: cargo update

      - name: Install Frontend Dependencies
        working-directory: ./toolboxv2
        run: |
          npm install
          npm install --prefix ./web
          cd simple-core && npm install && cd ..
          npm run build

      - name: Remove externalBin for Mobile
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: |
          python3 -c "
          import json
          with open('tauri.conf.json', 'r') as f:
              config = json.load(f)
          if 'bundle' in config and 'externalBin' in config['bundle']:
              del config['bundle']['externalBin']
          with open('tauri.conf.json', 'w') as f:
              json.dump(config, f, indent=2)
          "

      - name: Clean iOS Build Cache
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: |
          rm -rf gen/apple
          rm -rf target/aarch64-apple-ios
          rm -rf target/x86_64-apple-ios
          rm -rf target/aarch64-apple-ios-sim

      - name: Build iOS
        working-directory: ./toolboxv2/simple-core
        run: |
          cargo tauri ios init
          cargo tauri ios build --debug || true

      - name: Package Artifacts
        run: |
          mkdir -p artifacts
          find ./toolboxv2/simple-core -name "*.app" -type d -exec zip -r artifacts/ios-app.zip {} \; 2>/dev/null || true
          find ./toolboxv2/simple-core -name "*.ipa" -exec cp {} artifacts/ \; 2>/dev/null || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: artifacts/*

  # ============================================================================
  # PYTHON DISTRIBUTION BUILD - MIT CUSTOM FEATURE PACKING
  # ============================================================================

  build-python:
    name: Build Python Distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build pyyaml

      # ========================================
      # CUSTOM FEATURE PACKING STEP
      # ========================================
      - name: Pack Features into ZIPs
        run: |
          echo "=== Packing Features for Distribution ==="
          python build_package.py
          
          echo ""
          echo "=== Verifying Package Structure ==="
          python build_package.py --verify
          
          echo ""
          echo "=== Contents of features_packed/ ==="
          ls -la toolboxv2/features_packed/

      - name: Build Distribution
        run: |
          echo "=== Building Python Package ==="
          python -m build --outdir dist
          
          echo ""
          echo "=== Built Packages ==="
          ls -la dist/

      - name: Verify Package Contents
        run: |
          echo "=== Verifying Package includes Feature ZIPs ==="
          
          # Check wheel contents
          WHEEL=$(ls dist/*.whl | head -1)
          echo "Checking wheel: $WHEEL"
          python -m zipfile -l "$WHEEL" | grep -E "(features_packed|\.zip)" || echo "Warning: No feature ZIPs found in wheel"
          
          # Check tarball contents
          TAR=$(ls dist/*.tar.gz | head -1)
          echo "Checking tarball: $TAR"
          tar -tzf "$TAR" | grep -E "(features_packed|\.zip)" || echo "Warning: No feature ZIPs found in tarball"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: |
            dist/*.tar.gz
            dist/*.whl

  # ============================================================================
  # PYPI PUBLISH
  # ============================================================================

  pypi-publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-python]
    environment:
      name: pypi
      url: https://pypi.org/p/ToolBoxV2
    permissions:
      id-token: write
    steps:
      - name: Download Dist
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: List Distribution Files
        run: |
          echo "=== Distribution Files ==="
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # ============================================================================
  # INSTALLERS (General + Termux)
  # ============================================================================

  build-installers:
    name: Build Installers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Package Installers
        run: |
          mkdir -p artifacts

          # Copy main installer.sh
          cp installer.sh artifacts/installer.sh
          chmod +x artifacts/installer.sh

          # Create Termux installer
          mkdir -p artifacts/termux

          cat > artifacts/termux/install-toolboxv2.sh << 'EOF'
          #!/data/data/com.termux/files/usr/bin/bash
          set -e
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║         ToolBoxV2 - Termux Installer                         ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; NC='\033[0m'
          if [ ! -d "/data/data/com.termux" ]; then
              echo -e "${RED}Error: Run this in Termux!${NC}"; exit 1
          fi
          echo -e "${YELLOW}[1/5] Updating packages...${NC}"
          pkg update -y && pkg upgrade -y
          echo -e "${YELLOW}[2/5] Installing dependencies...${NC}"
          pkg install -y python python-pip git clang make
          echo -e "${YELLOW}[3/5] Installing Python packages...${NC}"
          pip install --upgrade pip wheel setuptools
          echo -e "${YELLOW}[4/5] Installing ToolBoxV2...${NC}"
          pip install ToolBoxV2 || pip install git+https://github.com/MarkinHaus/ToolBoxV2.git
          echo -e "${YELLOW}[5/5] Initializing...${NC}"
          tb -init main || python -m toolboxv2 -init main || true
          echo -e "${GREEN}Installation complete! Run: tb${NC}"
          EOF

          cat > artifacts/termux/toolboxv2-boot.sh << 'EOF'
          #!/data/data/com.termux/files/usr/bin/bash
          termux-wake-lock
          tb workers start || python -m toolboxv2 workers start
          EOF

          chmod +x artifacts/termux/*.sh
          cd artifacts/termux && tar -czvf ../termux-toolboxv2-installer.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: installers
          path: |
            artifacts/installer.sh
            artifacts/termux-toolboxv2-installer.tar.gz
            artifacts/termux/*.sh

  # ============================================================================
  # UPLOAD ALL ASSETS TO RELEASE
  # ============================================================================

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs:
      - build-frontend
      - build-tblang
      - build-browser-extension
      - build-nuitka
      - build-python
      - build-installers
      - build-tauri
      - build-android
      - build-ios
    if: always()
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/

      - name: List Artifacts
        run: find all-artifacts -type f | head -50

      - name: Prepare Release Assets
        run: |
          mkdir -p release-upload

          # Copy all artifacts to release folder
          for dir in all-artifacts/*/; do
            if [ -d "$dir" ]; then
              cp "$dir"* release-upload/ 2>/dev/null || true
            fi
          done

          echo "=== Release Assets ==="
          ls -la release-upload/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-upload/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
