name: Build & Test

on:
  push:
    branches:
      - light-tb
      - mod-server
      - master
      - main
      - develop
  pull_request:

env:
  PYTHON_VERSION_DEFAULT: "3.11"
  NODE_VERSION: "lts/*"

jobs:
  # ============================================================================
  # PYTHON MATRIX BUILD & TEST
  # ============================================================================

  py-check:
    runs-on: ${{ matrix.config.os }}
    name: Python ${{ matrix.config.py }} on ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: ubuntu-latest, py: "3.10" }
          - { os: ubuntu-latest, py: "3.11" }
          - { os: ubuntu-latest, py: "3.12" }
          - { os: ubuntu-latest, py: "3.13" }
          - { os: windows-latest, py: "3.10" }
          - { os: windows-latest, py: "3.11" }
          - { os: windows-latest, py: "3.12" }
          - { os: windows-latest, py: "3.13" }
          - { os: macos-latest, py: "3.10" }
          - { os: macos-latest, py: "3.11" }
          - { os: macos-latest, py: "3.12" }
          - { os: macos-latest, py: "3.13" }

    env:
      SDKROOT: /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.config.py }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.config.py }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          pip install --user --no-cache-dir Cython

      - name: Install toolboxv2 with ISAA
        run: |
          python -m uv pip install -e toolboxv2/mods/isaa --system
          python -m uv pip install . --system
        working-directory: ${{ github.workspace }}

      - name: Run Tests
        run: python -m unittest discover -s toolboxv2/tests/

  # ============================================================================
  # NODE.JS / FRONTEND BUILDS
  # ============================================================================

  build-root:
    name: Build Frontend (toolboxv2)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: toolboxv2
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install all packages
        run: |
          npm install
          npm install --prefix ./tbjs
          npm install --prefix ./web

      - name: Build all
        run: npm run build:tbjs && npm run build:web

      - name: Upload dist folder
        uses: actions/upload-artifact@v4
        with:
          name: root-dist
          path: toolboxv2/dist

  test-root:
    name: Test Frontend (tbjs)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install tbjs dependencies
        working-directory: ./toolboxv2/tbjs
        run: npm install

      - name: Run tbjs tests
        working-directory: ./toolboxv2/tbjs
        run: npm run test

  # ============================================================================
  # TBLANG BUILD & TEST
  # ============================================================================

  tblang:
    name: TBLang Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for TBLang project
        id: check
        shell: bash
        run: |
          if [ -f "./toolboxv2/tb-exc/src/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          elif [ -f "./toolboxv2/tb-exc/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Build TBLang
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/tb-exc/src
        run: cargo build --release
        continue-on-error: true

      - name: Test TBLang
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/tb-exc/src
        run: cargo test
        continue-on-error: true

  # ============================================================================
  # BROWSER EXTENSION BUILD
  # ============================================================================

  browser-extension:
      name: Browser Extension Build
      runs-on: ubuntu-latest
      steps:
          -   name: Checkout Code
              uses: actions/checkout@v4

          -   name: Check for browser extension
              id: check
              run: |
                  if [ -f "./toolboxv2/tb_browser/build.js" ] || [ -f "./toolboxv2/tb_browser/package.json" ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

          -   name: Setup Node.js
              if: steps.check.outputs.exists == 'true'
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

          -   name: Install dependencies
              if: steps.check.outputs.exists == 'true'
              working-directory: ./toolboxv2/tb_browser
              run: npm install || true

          -   name: Build extension
              if: steps.check.outputs.exists == 'true'
              working-directory: ./toolboxv2/tb_browser
              run: |
                  if [ -f "build.js" ]; then
                    # FIX: build.js requires 'dev', 'build', or 'zip' argument
                    # Use 'build' for production builds in CI
                    node build.js zip
                  elif [ -f "package.json" ]; then
                    npm run build || true
                  fi

          -   name: Upload extension artifact
              if: steps.check.outputs.exists == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: browser-extension
                  path: |
                      ./toolboxv2/tb_browser/dist/
                      ./toolboxv2/tb_browser/build/


  # ============================================================================
  # NUITKA BUILD (FIXED)
  # ============================================================================
  # Using the official Nuitka-Action for proper compilation
  # Supports Windows, macOS, and Linux with matrix strategy


  # ============================================================================
  # NUITKA BUILD (FIXED)
  # ============================================================================
  # FIX: In Nuitka 2.x+, --onefile is a mode itself, cannot combine with --mode=standalone
  # Use either:
  #   --mode=onefile (single executable)
  #   --mode=standalone (folder with exe + libs)
  #   --mode=app (GUI app bundle)

  nuitka-build:
      name: Nuitka Build (${{ matrix.os }})
      runs-on: ${{ matrix.os }}
      strategy:
          fail-fast: false
          matrix:
              os: [ ubuntu-latest, windows-latest, macos-latest ]
              python-version: [ '3.11' ]

      steps:
          -   name: Checkout Code
              uses: actions/checkout@v4

          -   name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  architecture: 'x64'
                  cache: 'pip'

          -   name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt || pip install .

          # Using Nuitka-Action with FIXED mode setting
          -   name: Build with Nuitka Action
              uses: Nuitka/Nuitka-Action@main
              with:
                  nuitka-version: main
                  script-name: toolboxv2/__main__.py
                  # FIX: Use mode=onefile for single binary (don't combine with onefile: true)
                  # Options: 'onefile', 'standalone', 'app', 'module'
                  mode: onefile
                  # Output directory
                  output-dir: build
                  # Include package data
                  include-package: toolboxv2
                  # Auto-download missing dependencies
                  assume-yes-for-downloads: true

          -   name: Upload Nuitka Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: nuitka-${{ runner.os }}-${{ matrix.python-version }}
                  path: |
                      build/*.exe
                      build/*.bin
                      build/*.app/**/*
                  include-hidden-files: true


  tauri-test:
    name: Tauri Build Test (${{ matrix.platform }})
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            rust_targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
            target_triple: 'aarch64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
            rust_targets: ''
            target_triple: 'x86_64-unknown-linux-gnu'
          - platform: 'windows-latest'
            args: ''
            rust_targets: ''
            target_triple: 'x86_64-pc-windows-msvc'
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libxdo-dev

      - name: Setup Python for Worker
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ToolBoxV2 for Worker Build
        run: |
          pip install --upgrade pip
          pip install pyinstaller
          pip install -e .

      - name: Create Worker Wrapper Binary
        shell: bash
        run: |
          # Create binaries directory
          mkdir -p ./toolboxv2/simple-core/src-tauri/binaries

          # Create the worker runner script
          cat > worker_runner.py << 'PYEOF'
          #!/usr/bin/env python3
          """ToolBoxV2 Worker Runner - Sidecar for Tauri Desktop App"""
          import sys
          import os
          import argparse

          def main():
              parser = argparse.ArgumentParser(description='ToolBoxV2 HTTP Worker')
              parser.add_argument('--http-port', type=int, default=5000)
              parser.add_argument('--ws-port', type=int, default=5001)
              parser.add_argument('--mode', type=str, default='tauri')
              args, unknown = parser.parse_known_args()

              try:
                  from toolboxv2.utils.workers.server_worker import run_http_worker
                  run_http_worker(port=args.http_port, ws_port=args.ws_port, mode=args.mode)
              except ImportError as e:
                  print(f"Error: toolboxv2 not installed: {e}", file=sys.stderr)
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          PYEOF

          # Build with PyInstaller
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            pyinstaller --onefile --name "tb-worker-${{ matrix.target_triple }}" --console worker_runner.py
            cp dist/tb-worker-${{ matrix.target_triple }}.exe ./toolboxv2/simple-core/src-tauri/binaries/
          else
            pyinstaller --onefile --name "tb-worker-${{ matrix.target_triple }}" worker_runner.py
            cp dist/tb-worker-${{ matrix.target_triple }} ./toolboxv2/simple-core/src-tauri/binaries/
            chmod +x ./toolboxv2/simple-core/src-tauri/binaries/tb-worker-${{ matrix.target_triple }}
          fi

          echo "Created worker binary: tb-worker-${{ matrix.target_triple }}"
          ls -la ./toolboxv2/simple-core/src-tauri/binaries/

      - name: Install frontend dependencies
        working-directory: ./toolboxv2
        run: |
          npm install
          npm install --prefix ./web
          npm install --prefix ./simple-core
          npm run build

      - name: Build Tauri (dry-run)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: ./toolboxv2/simple-core
          tauriScript: npx tauri
          tagName: simple-v__VERSION__
          releaseName: 'App v__VERSION__'
          releaseBody: 'CI Test Build'
          releaseDraft: true
          prerelease: true
          args: ${{ matrix.args }}

  # ============================================================================
  # ANDROID BUILD TEST (Tauri Mobile)
  # ============================================================================

  android-test:
    name: Android Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Update Cargo dependencies
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: cargo update

      - name: Install frontend dependencies
        working-directory: ./toolboxv2
        run: |
          npm install
          npm install --prefix ./web
          cd simple-core && npm install && cd ..
          npm run build

      - name: Initialize Android project
        working-directory: ./toolboxv2/simple-core
        run: cargo tauri android init || true

      - name: Build Android APK (Debug)
        working-directory: ./toolboxv2/simple-core
        run: cargo tauri android build --debug
        continue-on-error: true

  # ============================================================================
  # iOS BUILD TEST (Tauri Mobile)
  # ============================================================================

  ios-test:
    name: iOS Build Test
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2"

      - name: Update Cargo dependencies
        working-directory: ./toolboxv2/simple-core/src-tauri
        run: cargo update

      - name: Install frontend dependencies
        working-directory: ./toolboxv2
        run: |
          npm install
          npm install --prefix ./web
          cd simple-core && npm install && cd ..
          npm run build

      - name: Initialize iOS project
        working-directory: ./toolboxv2/simple-core
        run: cargo tauri ios init || true

      - name: Build iOS (Simulator Debug)
        working-directory: ./toolboxv2/simple-core
        run: cargo tauri ios build --debug
        continue-on-error: true

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [py-check, build-root]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: root-dist
          path: toolboxv2/dist
        continue-on-error: true

      - name: Install toolboxv2
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          python -m uv pip install -e . --system

      - name: Run integration tests
        run: |
          tb --test -n test || python -m pytest tests/integration/ || true
        continue-on-error: true

  # ============================================================================
  # CODE QUALITY CHECKS
  # ============================================================================

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff mypy black isort

      - name: Run Ruff
        run: ruff check . || true
        continue-on-error: true

      - name: Run Black (check only)
        run: black --check . || true
        continue-on-error: true

      - name: Check Rust formatting (Tauri)
        run: |
          cd toolboxv2/simple-core/src-tauri
          cargo fmt --check || true
        continue-on-error: true

      - name: Check Rust formatting (TBLang)
        run: |
          if [ -d "toolboxv2/tb-exc/src" ]; then
            cd toolboxv2/tb-exc/src
            cargo fmt --check || true
          fi
        continue-on-error: true

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install safety bandit

      - name: Run Safety check
        run: safety check || true
        continue-on-error: true

      - name: Run Bandit
        run: bandit -r toolboxv2/ -x toolboxv2/tests || true
        continue-on-error: true

      - name: Rust security audit (Tauri)
        run: |
          cargo install cargo-audit || true
          cd toolboxv2/simple-core/src-tauri
          cargo audit || true
        continue-on-error: true

      - name: Rust security audit (TBLang)
        run: |
          if [ -d "toolboxv2/tb-exc/src" ]; then
            cd toolboxv2/tb-exc/src
            cargo audit || true
          fi
        continue-on-error: true

  # ============================================================================
  # BUILD STATUS SUMMARY
  # ============================================================================

  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs:
      - py-check
      - build-root
      - test-root
      - tblang
      - browser-extension
      - nuitka-build
      - tauri-test
      - android-test
      - ios-test
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.py-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.build-root.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.test-root.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TBLang | ${{ needs.tblang.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser Extension | ${{ needs.browser-extension.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nuitka Test | ${{ needs.nuitka-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tauri Desktop | ${{ needs.tauri-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.android-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.ios-test.result }} |" >> $GITHUB_STEP_SUMMARY
