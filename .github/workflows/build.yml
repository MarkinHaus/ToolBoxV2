name: Build & Test

on:
  push:
    branches:
      - light-tb
      - mod-server
      - master
      - main
      - develop
  pull_request:

env:
  PYTHON_VERSION_DEFAULT: "3.11"
  NODE_VERSION: "lts/*"

jobs:
  # ============================================================================
  # PYTHON MATRIX BUILD & TEST
  # ============================================================================

  py-check:
    runs-on: ${{ matrix.config.os }}
    name: Python ${{ matrix.config.py }} on ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: ubuntu-latest, py: "3.10" }
          - { os: ubuntu-latest, py: "3.11" }
          - { os: ubuntu-latest, py: "3.12" }
          - { os: ubuntu-latest, py: "3.13" }
          - { os: windows-latest, py: "3.10" }
          - { os: windows-latest, py: "3.11" }
          - { os: windows-latest, py: "3.12" }
          - { os: windows-latest, py: "3.13" }
          - { os: macos-latest, py: "3.10" }
          - { os: macos-latest, py: "3.11" }
          - { os: macos-latest, py: "3.12" }
          - { os: macos-latest, py: "3.13" }

    env:
      SDKROOT: /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.config.py }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.config.py }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          pip install --user --no-cache-dir Cython

      - name: Install toolboxv2 with ISAA
        run: |
          python -m uv pip install -e toolboxv2/mods/isaa --system
          python -m uv pip install . --system
        working-directory: ${{ github.workspace }}

      - name: Run Tests
        run: python -m unittest discover -s toolboxv2/tests/

  # ============================================================================
  # NODE.JS / FRONTEND BUILDS
  # ============================================================================

  build-root:
    name: Build Frontend (toolboxv2)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: toolboxv2
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install all packages
        run: |
          npm install
          npm install --prefix ./tbjs
          npm install --prefix ./web

      - name: Build all
        run: npm run build:tbjs && npm run build:web

      - name: Upload dist folder
        uses: actions/upload-artifact@v4
        with:
          name: root-dist
          path: toolboxv2/dist

  test-root:
    name: Test Frontend (tbjs)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install tbjs dependencies
        working-directory: ./toolboxv2/tbjs
        run: npm install

      - name: Run tbjs tests
        working-directory: ./toolboxv2/tbjs
        run: npm run test

  # ============================================================================
  # TBLANG BUILD & TEST
  # ============================================================================

  tblang:
    name: TBLang Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for TBLang project
        id: check
        shell: bash
        run: |
          if [ -f "./toolboxv2/tb-exc/src/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          elif [ -f "./toolboxv2/tb-exc/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Build TBLang
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/tb-exc/src
        run: cargo build --release
        continue-on-error: true

      - name: Test TBLang
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/tb-exc/src
        run: cargo test
        continue-on-error: true
  # ============================================================================
  # r_DB BUILD & TEST
  # ============================================================================

  r_blob_db:
    name: Blob DB Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for TBLang project
        id: check
        shell: bash
        run: |
          if [ -f "./toolboxv2/r_blob_db/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          elif [ -f "./toolboxv2/r_blob_dbCargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Build Blob DB
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/r_blob_db
        run: cargo build --release
        continue-on-error: true

      - name: Test Blob DB
        if: steps.check.outputs.exists == 'true'
        working-directory: ./toolboxv2/r_blob_db
        run: cargo test
        continue-on-error: true

  # ============================================================================
  # BROWSER EXTENSION BUILD
  # ============================================================================

  browser-extension:
      name: Browser Extension Build
      runs-on: ubuntu-latest
      steps:
          -   name: Checkout Code
              uses: actions/checkout@v4

          -   name: Check for browser extension
              id: check
              run: |
                  if [ -f "./toolboxv2/tb_browser/build.js" ] || [ -f "./toolboxv2/tb_browser/package.json" ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

          -   name: Setup Node.js
              if: steps.check.outputs.exists == 'true'
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

          -   name: Install dependencies
              if: steps.check.outputs.exists == 'true'
              working-directory: ./toolboxv2/tb_browser
              run: npm install || true

          -   name: Build extension
              if: steps.check.outputs.exists == 'true'
              working-directory: ./toolboxv2/tb_browser
              run: |
                  if [ -f "build.js" ]; then
                    # FIX: build.js requires 'dev', 'build', or 'zip' argument
                    # Use 'build' for production builds in CI
                    node build.js zip
                  elif [ -f "package.json" ]; then
                    npm run build || true
                  fi

          -   name: Upload extension artifact
              if: steps.check.outputs.exists == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: browser-extension
                  path: |
                      ./toolboxv2/tb_browser/dist/
                      ./toolboxv2/tb_browser/build/


  # ============================================================================
  # NUITKA BUILD (FIXED)
  # ============================================================================
  # Using the official Nuitka-Action for proper compilation
  # Supports Windows, macOS, and Linux with matrix strategy


  # ============================================================================
  # NUITKA BUILD (FIXED)
  # ============================================================================
  # FIX: In Nuitka 2.x+, --onefile is a mode itself, cannot combine with --mode=standalone
  # Use either:
  #   --mode=onefile (single executable)
  #   --mode=standalone (folder with exe + libs)
  #   --mode=app (GUI app bundle)

  nuitka-build:
      name: Nuitka Build (${{ matrix.os }})
      runs-on: ${{ matrix.os }}
      strategy:
          fail-fast: false
          matrix:
              os: [ ubuntu-latest, windows-latest, macos-latest ]
              python-version: [ '3.11' ]

      steps:
          -   name: Checkout Code
              uses: actions/checkout@v4

          -   name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  architecture: 'x64'
                  cache: 'pip'

          -   name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt || pip install .

          # Using Nuitka-Action with FIXED mode setting
          -   name: Build with Nuitka Action
              uses: Nuitka/Nuitka-Action@main
              with:
                  nuitka-version: main
                  script-name: toolboxv2/__main__.py
                  # FIX: Use mode=onefile for single binary (don't combine with onefile: true)
                  # Options: 'onefile', 'standalone', 'app', 'module'
                  mode: onefile
                  # Output directory
                  output-dir: build
                  # Include package data
                  include-package: toolboxv2
                  # Auto-download missing dependencies
                  assume-yes-for-downloads: true

          -   name: Upload Nuitka Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: nuitka-${{ runner.os }}-${{ matrix.python-version }}
                  path: |
                      build/*.exe
                      build/*.bin
                      build/*.app/**/*
                  include-hidden-files: true


  tauri-test:
    name: Tauri Build Test (${{ matrix.platform }})
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            rust_targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
            rust_targets: ''
          - platform: 'windows-latest'
            args: ''
            rust_targets: ''
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libxdo-dev

      - name: Build Worker Server
        working-directory: ./toolboxv2/src-core
        shell: bash
        run: |
          # Determine target based on platform
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            # Extract target from args (e.g., --target aarch64-apple-darwin)
            TARGET="${{ matrix.args }}"
            TARGET="${TARGET#*--target }"
            TARGET="${TARGET%% *}"
            if [[ -z "$TARGET" || "$TARGET" == "${{ matrix.args }}" ]]; then
              # No target specified, use default
              TARGET="$(rustc -vV | sed -n 's|host: ||p')"
            fi
          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            TARGET="x86_64-pc-windows-msvc"
          else
            TARGET="x86_64-unknown-linux-gnu"
          fi

          echo "Building worker server for target: $TARGET"
          cargo build --release --target "$TARGET"

          # Create binaries directory
          mkdir -p ../simple-core/src-tauri/binaries

          # Copy binary to Tauri binaries folder with correct name
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp "target/$TARGET/release/simple-core-server.exe" "../simple-core/src-tauri/binaries/tb-worker-x86_64-pc-windows-msvc.exe"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            cp "target/$TARGET/release/simple-core-server" "../simple-core/src-tauri/binaries/tb-worker-$TARGET"
          else
            cp "target/$TARGET/release/simple-core-server" "../simple-core/src-tauri/binaries/tb-worker-x86_64-unknown-linux-gnu"
          fi

      - name: Install frontend dependencies
        working-directory: ./toolboxv2/web
        run: |
          npm install
          cd ../simple-core
          npm install
          cd ..
          npm install
          npm run build

      - name: Build Tauri (dry-run)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: ./toolboxv2/simple-core
          tauriScript: npx tauri
          tagName: simple-v__VERSION__
          releaseName: 'App v__VERSION__'
          releaseBody: 'CI Test Build'
          releaseDraft: true
          prerelease: true
          args: ${{ matrix.args }}

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [py-check, build-root]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: root-dist
          path: toolboxv2/dist
        continue-on-error: true

      - name: Install toolboxv2
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          python -m uv pip install -e . --system

      - name: Run integration tests
        run: |
          tb --test -n test || python -m pytest tests/integration/ || true
        continue-on-error: true

  # ============================================================================
  # CODE QUALITY CHECKS
  # ============================================================================

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff mypy black isort

      - name: Run Ruff
        run: ruff check . || true
        continue-on-error: true

      - name: Run Black (check only)
        run: black --check . || true
        continue-on-error: true

      - name: Check Rust formatting
        run: |
          cd toolboxv2/src-core
          cargo fmt --check || true
        continue-on-error: true

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install safety bandit

      - name: Run Safety check
        run: safety check || true
        continue-on-error: true

      - name: Run Bandit
        run: bandit -r toolboxv2/ -x toolboxv2/tests || true
        continue-on-error: true

      - name: Rust security audit
        run: |
          cargo install cargo-audit || true
          cd toolboxv2/src-core
          cargo audit || true
        continue-on-error: true

  # ============================================================================
  # BUILD STATUS SUMMARY
  # ============================================================================

  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs:
      - py-check
      - build-root
      - test-root
      - tblang
      - r_blob_db
      - browser-extension
      - nuitka-build
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.py-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.build-root.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.test-root.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TBLang | ${{ needs.tblang.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser Extension | ${{ needs.browser-extension.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nuitka Test | ${{ needs.nuitka-build.result }} |" >> $GITHUB_STEP_SUMMARY
